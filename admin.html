
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการาคลังสินค้า WH1</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #135bec;
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            --orange-light: #fed7aa;
            --orange-50: #fff7ed;
            --orange-100: #ffedd5;
            --orange-200: #fed7aa;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .page-container {
             font-family: "Noto Sans Thai", "Inter", sans-serif;
             width: 100%;
             max-width: 100%;
        }

        /* Style for select dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24' 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }
        .status-btn.active {
            background-color: var(--primary-600) !important;
            color: white !important;
            font-weight: bold;
        }
        .tab-btn.active {
            border-bottom-color: var(--primary-600);
            color: var(--primary-600);
            font-weight: 600;
        }
        .department-tab {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
            margin-right: 8px;
            font-size: 14px;
        }
        .department-tab:hover {
            background-color: #f3f4f6;
            color: #374151;
        }
        .department-tab.active {
            background-color: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }
        
        /* Week display styles */
        #week-display {
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
            border: 2px solid var(--primary-200);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        
        #week-display.hidden {
            display: none;
        }
        
        #week-range {
            font-weight: 600;
            color: var(--primary-700);
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .week-note {
            color: var(--primary-600);
            font-size: 14px;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-50 flex justify-center items-center min-h-screen">
    


    <!-- Auth Wrapper -->
    <div id="auth-wrapper" class="w-full max-w-sm p-8">
        <!-- Registration Form -->
        <div id="register-container" class="hidden">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800 tracking-tighter">Create Account</h1>
                <p class="text-gray-500 mt-2">Let's get you started!</p>
            </div>
            <form id="register-form" class="space-y-6">
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">person</span><input id="register-username" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Username" type="text" required></div>
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">badge</span><input id="register-fullname" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="ชื่อ-นามสกุล" type="text" required></div>
                
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">work</span>
                    <select id="register-position" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" required>
                        <option value="" disabled selected>กรุณาเลือกตำแหน่ง</option>
                        <option value="Senior Warehouse Manager">Senior Warehouse Manager</option>
                        <option value="Asistant Warehouse Manager">Asistant Warehouse Manager</option>
                        <option value="Warehouse Supervisor">Warehouse Supervisor</option>
                        <option value="Sr.Warehouse Officer">Sr.Warehouse Officer</option>
                        <option value="Warehouse Officer">Warehouse Officer</option>
                        <option value="Sr.Forklift Driver">Sr.Forklift Driver</option>
                        <option value="Technical Service Forklift">Technical Service Forklift</option>
                        <option value="Forklift Driver">Forklift Driver</option>
                        <option value="Sr.Inspector">Sr.Inspector</option>
                        <option value="Inspector">Inspector</option>
                        <option value="Operator">Operator</option>
                    </select>
                </div>

                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">groups</span>
                    <select id="register-department" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" required>
                        <option value="" disabled selected>กรุณาเลือกส่วนงาน</option>
                        <option value="Warehouse Manager">Warehouse Manager</option>
                        <option value="Asistant Warehouse Manager">Asistant Warehouse Manager</option>
                        <option value="A&I">A&I</option>
                        <option value="MH">MH</option>
                        <option value="SSRM">SSRM</option>
                        <option value="COIL">COIL</option>
                        <option value="FILM">FILM</option>
                    </select>
                </div>
                
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock</span><input id="register-password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Password" type="password" required></div>
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock_reset</span><input id="confirm-password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Confirm Password" type="password" required></div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">Register</button>
            </form>
            <div class="text-center mt-6"><p class="text-sm text-gray-500">Already have an account? <a href="#" id="show-login" class="font-semibold text-[var(--primary-color)] hover:underline">Login</a></p></div>
        </div>

        <!-- Login Form -->
        <div id="login-container">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800 tracking-tighter">เข้าสู่ระบบ Admin WH 1</h1>
                <p class="text-gray-500 mt-2">Please login to your account.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">person</span><input id="login-username" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Username / Employee ID" type="text" required></div>
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock</span><input id="login-password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Password" type="password" required></div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">Login</button>
            </form>
            <div class="text-center mt-6"><p class="text-sm text-gray-500">Don't have an account? <a href="#" id="show-register" class="font-semibold text-[var(--primary-color)] hover:underline">Register</a></p></div>
        </div>
    </div>
    
    <!-- Home Page -->
    <div id="home-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">หน้าหลัก</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main class="flex-1 p-6 pb-28 flex justify-center items-center"><h2 class="text-2xl text-gray-600">ยินดีต้อนรับสู่หน้าหลัก</h2></main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">checklist</span><p class="text-xs font-medium">เช็คชื่อ</p></a><a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)] cursor-pointer"><span class="material-symbols-outlined">more_horiz</span><p class="text-xs font-medium">เพิ่มเติม</p></a></nav></footer>
    </div>
    
    <!-- Employee List Page -->
    <div id="employee-list-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">รายชื่อพนักงาน wh1</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main id="employee-list-main" class="flex-1 p-4 md:p-6 pb-28 overflow-y-auto"></main>
         <button id="add-employee-fab" class="fixed bottom-20 right-6 bg-[var(--primary-600)] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-[var(--primary-700)] transition-transform transform hover:scale-110"><span class="material-symbols-outlined">add</span></button>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">checklist</span><p class="text-xs font-medium">เช็คชื่อ</p></a><a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)] cursor-pointer"><span class="material-symbols-outlined">more_horiz</span><p class="text-xs font-medium">เพิ่มเติม</p></a></nav></footer>
    </div>

    <!-- Add/Edit Employee Page -->
    <div id="add-employee-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-start p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);"><button id="back-to-list-button" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-100"><span class="material-symbols-outlined text-gray-700">arrow_back_ios_new</span></button><h1 id="employee-form-title" class="text-xl font-bold text-gray-800 flex-1 text-center">เพิ่มข้อมูลพนักงาน</h1><div class="w-10"></div></header>
        <main class="flex-1 p-6 pb-28 space-y-6 overflow-y-auto">
            <div class="flex flex-col items-center space-y-4">
                <div class="relative w-32 h-32"><img alt="Employee Photo" id="photo-preview" class="w-full h-full rounded-full object-cover" src="https://placehold.co/128x128/EFEFEF/AAAAAA?text=Photo"><label class="absolute bottom-0 right-0 flex items-center justify-center w-10 h-10 bg-[var(--primary-600)] rounded-full cursor-pointer hover:bg-[var(--primary-700)]" for="photo-upload"><span class="material-symbols-outlined text-white">photo_camera</span><input class="hidden" id="photo-upload" type="file" accept="image/*"></label></div>
                <p class="text-gray-500 text-sm">อัปโหลดรูปถ่ายพนักงาน</p>
            </div>
            <form id="employee-form" class="space-y-6">
                <div><label class="block text-sm font-medium text-gray-700" for="full-name">ชื่อ-นามสกุล</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="full-name" placeholder="เช่น สุดา สุนทร" type="text"></div>
                <div><label class="block text-sm font-medium text-gray-700" for="employee-id">รหัสพนักงาน</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="employee-id" placeholder="เช่น 123456" type="text"></div>
                <div><label class="block text-sm font-medium text-gray-700" for="department">ส่วนงาน</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="department" placeholder="เช่น ฝ่ายขาย" type="text"></div>
                <div><label class="block text-sm font-medium text-gray-700" for="position">ตำแหน่ง</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="position" placeholder="เช่น พนักงานขาย" type="text"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="role">Role (สิทธิ์การเข้าถึง)</label>
                    <select id="role" class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium text-gray-700" for="start-date">วันที่เริ่มงาน</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm text-gray-500" id="start-date" type="date"></div>
            </form>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0"><div class="px-6 py-4"><button id="save-employee-button" type="submit" form="employee-form" class="w-full flex items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-[var(--primary-600)] text-white text-base font-bold leading-normal tracking-wide shadow-md hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]"><span class="truncate">บันทึก</span></button></div></footer>
    </div>

    <!-- Shift Management Page -->
    <div id="shift-management-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <div class="w-10"></div>
            <h1 class="text-xl font-bold text-gray-800">จัดการเข้ากะ</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main id="shift-management-main" class="flex-1 p-4 md:p-6 pb-28 flex flex-col">
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-4 flex-shrink-0">
                <div class="flex border-b border-gray-200">
                    <button id="shift-assignment-tab" class="tab-button flex-1 px-6 py-4 text-center font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-colors">
                        <span class="material-symbols-outlined text-base mr-2">schedule</span>
                        จัดกะอัตโนมัติ
                    </button>
                    <button id="shift-summary-tab" class="tab-button flex-1 px-6 py-4 text-center font-medium text-gray-500 hover:text-gray-700 transition-colors">
                        <span class="material-symbols-outlined text-base mr-2">analytics</span>
                        รายงานสรุปกะ
                    </button>
                </div>
            </div>

            <!-- Shift Assignment Tab Content -->
            <div id="shift-assignment-content" class="tab-content flex-1 flex flex-col">
                <!-- Shift Type Selection -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex-shrink-0">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">เลือกประเภทกะ</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button id="morning-shift-btn" class="shift-type-btn bg-blue-100 border-2 border-blue-300 text-blue-800 p-4 rounded-lg hover:bg-blue-200 transition-colors">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-2xl mb-2 block">wb_sunny</span>
                            <h3 class="font-semibold">กะเช้า</h3>
                            <p class="text-sm">08:00 - 17:00</p>
                        </div>
                    </button>
                    <button id="night-shift-btn" class="shift-type-btn bg-purple-100 border-2 border-purple-300 text-purple-800 p-4 rounded-lg hover:bg-purple-200 transition-colors">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-2xl mb-2 block">nights_stay</span>
                            <h3 class="font-semibold">กะดึก</h3>
                            <p class="text-sm">20:00 - 08:00</p>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Week Selection -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex-shrink-0">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">เลือกสัปดาห์</h2>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">สัปดาห์ที่เริ่มต้น:</label>
                        <input type="date" id="week-start-picker" class="border border-gray-300 rounded-lg p-2">
                    </div>
                    <div id="week-display" class="bg-gray-50 p-3 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">สัปดาห์ที่เลือก:</span>
                            <span id="week-range" class="text-sm text-blue-600 font-medium"></span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            <span class="material-symbols-outlined text-sm mr-1">info</span>
                            1 สัปดาห์ต่อ 1 คน (จันทร์ - อาทิตย์)
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Employee List for Shift Assignment -->
            <div class="bg-white rounded-lg shadow-sm flex-1 overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">กำหนดกะพนักงาน</h2>
                            <div id="selected-count" class="text-sm text-blue-600 font-medium mt-1 hidden">
                                เลือกแล้ว: <span id="selected-count-number">0</span> คน
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button id="auto-assign-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <span class="material-symbols-outlined text-base">auto_awesome</span>
                                <span>จัดกะอัตโนมัติ</span>
                            </button>
                            <button id="save-shift-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center" disabled>
                                <span class="material-symbols-outlined mr-1 text-base">save</span>
                                บันทึก
                            </button>
                        </div>
                    </div>
                    <p id="shift-info" class="text-sm text-gray-600 mt-2">เลือกประเภทกะและสัปดาห์เพื่อเริ่มกำหนดกะ (สามารถเลือกพนักงานหลายคนต่อสัปดาห์)</p>
                    <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start space-x-2">
                            <span class="material-symbols-outlined text-blue-600 text-sm mt-0.5">info</span>
                            <div class="text-xs text-blue-800">
                                <p class="font-medium mb-1">วิธีใช้ฟีเจอร์จัดกะอัตโนมัติ:</p>
                                <p>1. เลือกประเภทกะและสัปดาห์</p>
                                <p>2. เลือกพนักงานที่ต้องการเข้ากะที่เลือก</p>
                                <p>3. กดปุ่ม "จัดกะอัตโนมัติ" เพื่อจัดพนักงานที่เหลือเข้ากะตรงข้ามโดยอัตโนมัติ</p>
                                <p class="text-orange-700 font-medium mt-1">เช่น: เลือกกะเช้า 6 คน → พนักงานที่เหลือจะเข้ากะดึกอัตโนมัติ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Department Tabs -->
                    <div id="department-tabs" class="mt-4 hidden">
                        <div class="flex space-x-2 overflow-x-auto">
                            <!-- Tabs will be dynamically generated -->
                        </div>
                    </div>
                </div>
                <div id="shift-employee-list" class="p-4 overflow-y-auto">
                    <p class="text-center text-gray-500 py-8">เลือกประเภทกะและสัปดาห์เพื่อแสดงรายชื่อพนักงาน</p>
                </div>
            </div>
            </div>

            <!-- Shift Summary Tab Content -->
            <div id="shift-summary-content-tab" class="tab-content hidden flex-1 flex flex-col">
                <!-- Summary Controls -->
                <div class="bg-white rounded-lg shadow-sm mb-4 flex-shrink-0">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-600">analytics</span>
                                <h2 class="text-lg font-semibold text-gray-800">รายงานสรุปกะรายสัปดาห์</h2>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="generate-shift-summary-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
                                    <span class="material-symbols-outlined text-base">refresh</span>
                                    สร้างรายงาน
                                </button>
                                <button id="export-shift-summary-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2 text-sm disabled:bg-gray-400" disabled>
                                    <span class="material-symbols-outlined text-base">download</span>
                                    ส่งออก Excel
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">สรุปจำนวนพนักงานแต่ละแผนกที่เข้ากะเช้า-กะดึกในแต่ละสัปดาห์ พร้อมรายชื่อ</p>
                    </div>
                </div>

                <!-- Summary Content -->
                <div class="bg-white rounded-lg shadow-sm flex-1 overflow-hidden">
                    <div id="shift-summary-content" class="p-4 h-full overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <span class="material-symbols-outlined text-4xl mb-2 block">bar_chart</span>
                            <p>กดปุ่ม "สร้างรายงาน" เพื่อดูสรุปข้อมูลกะรายสัปดาห์</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Shift Schedule Page -->
    <div id="shift-schedule-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <div class="w-10"></div>
            <h1 class="text-xl font-bold text-gray-800">ตารางกะ</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main id="shift-schedule-main" class="flex-1 p-4 md:p-6 pb-28 flex flex-col">
            <!-- Date Selection -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">เลือกวันที่</h2>
                    <div class="flex items-center gap-2">
                        <input type="date" id="schedule-date-picker" class="border border-gray-300 rounded-lg p-2">
                        <button id="load-schedule-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                            <span class="material-symbols-outlined mr-1 text-base">search</span>
                            โหลด
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Schedule Table -->
            <div class="bg-white rounded-lg shadow-sm flex-1 overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-800">ตารางกะรายวัน</h2>
                        <button id="save-schedule-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center" disabled>
                            <span class="material-symbols-outlined mr-1 text-base">save</span>
                            บันทึก
                        </button>
                    </div>
                    <p id="schedule-info" class="text-sm text-gray-600 mt-2">เลือกวันที่เพื่อดูและแก้ไขตารางกะ</p>
                </div>
                <div id="schedule-table-container" class="p-4 overflow-y-auto">
                    <p class="text-center text-gray-500 py-8">เลือกวันที่เพื่อแสดงตารางกะ</p>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Attendance Page -->
    <div id="attendance-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">เช็คชื่อพนักงาน</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main id="attendance-main" class="flex-1 p-4 md:p-6 pb-28 flex flex-col">
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                     <h2 class="text-lg font-semibold text-gray-800">เลือกวันที่</h2>
                    <input type="date" id="attendance-date-picker" class="border border-gray-300 rounded-lg p-2">
                </div>
            </div>
            <div id="attendance-tabs" class="flex border-b border-gray-200 bg-white rounded-t-lg overflow-x-auto flex-shrink-0"></div>
            <div id="attendance-tab-content" class="overflow-y-auto flex-grow pb-28"></div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">checklist</span><p class="text-xs font-medium">เช็คชื่อ</p></a><a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)] cursor-pointer"><span class="material-symbols-outlined">more_horiz</span><p class="text-xs font-medium">เพิ่มเติม</p></a></nav></footer>
    </div>
    
    <!-- OT Plan Page -->
    <div id="ot-plan-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">วางแผน OT</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main id="ot-plan-main" class="flex-1 p-4 md:p-6 pb-28 flex flex-col">
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex-shrink-0">
                <div class="flex items-center justify-between mb-4">
                     <h2 class="text-lg font-semibold text-gray-800">เลือกวันที่</h2>
                    <input type="date" id="ot-date-picker" class="border border-gray-300 rounded-lg p-2">
                </div>
                <div id="ot-total-summary" class="bg-blue-50 border border-blue-200 rounded-lg p-3 hidden">
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-semibold text-blue-800">สรุปรวมทั้งหมด:</span>
                        <div class="flex gap-4 text-blue-700">
                            <span id="total-all-employees">พนักงานทั้งหมด: 0 คน</span>
                            <span id="total-all-ot-employees">OT: 0 คน</span>
                            <span id="total-all-ot-hours" class="font-bold">รวม: 0.0 ชั่วโมง</span>
                        </div>
                    </div>
                </div>
            </div>
             <div id="ot-plan-tabs" class="flex border-b border-gray-200 bg-white rounded-t-lg overflow-x-auto flex-shrink-0"></div>
            <div id="ot-plan-tab-content" class="overflow-y-auto flex-grow pb-28"></div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">checklist</span><p class="text-xs font-medium">เช็คชื่อ</p></a><a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer"><span class="material-symbols-outlined">more_horiz</span><p class="text-xs font-medium">เพิ่มเติม</p></a></nav></footer>
    </div>

    <!-- Reports Container -->
    <div id="reports-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <div class="w-10"></div>
            <h1 class="text-xl font-bold text-gray-800">รายงาน</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center mb-4">
                        <span class="material-symbols-outlined text-blue-600 text-2xl mr-3">assessment</span>
                        <h3 class="text-lg font-semibold text-gray-800">รายงานการเข้างาน</h3>
                    </div>
                    <p class="text-gray-600 mb-4">ดูรายงานการลาของพนักงานจัดกลุ่มตามส่วนงาน</p>
                    <button id="attendance-report-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">ดูรายงาน</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center mb-4">
                        <span class="material-symbols-outlined text-green-600 text-2xl mr-3">schedule</span>
                        <h3 class="text-lg font-semibold text-gray-800">รายงาน OT</h3>
                    </div>
                    <p class="text-gray-600 mb-4">สรุปชั่วโมงทำงานล่วงเวลาของพนักงาน</p>
                    <button id="ot-report-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">ดูรายงาน</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center mb-4">
                        <span class="material-symbols-outlined text-purple-600 text-2xl mr-3">analytics</span>
                        <h3 class="text-lg font-semibold text-gray-800">รายงานสรุป</h3>
                    </div>
                    <p class="text-gray-600 mb-4">รายงานสรุปประจำเดือนและประจำปี</p>
                    <button class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">ดูรายงาน</button>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Leave Report Container -->
    <div id="leave-report-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <button id="back-to-reports-from-ot-btn" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="กลับ">
                <span class="material-symbols-outlined text-gray-700">arrow_back</span>
            </button>
            <h1 class="text-xl font-bold text-gray-800">รายงาน OT</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28 overflow-y-auto">
            <!-- Filters Section -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">ตัวกรองข้อมูล</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
                        <input type="date" id="ot-start-date" class="w-full border border-gray-300 rounded-lg p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
                        <input type="date" id="ot-end-date" class="w-full border border-gray-300 rounded-lg p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">แผนก</label>
                        <select id="ot-department-filter" class="w-full border border-gray-300 rounded-lg p-2">
                            <option value="">ทุกแผนก</option>
                            <option value="Warehouse Manager">Warehouse Manager</option>
                            <option value="Assistant Warehouse Manager">Assistant Warehouse Manager</option>
                            <option value="A&I">A&I</option>
                            <option value="MH">MH</option>
                            <option value="SSRM">SSRM</option>
                            <option value="COIL">COIL</option>
                            <option value="FILM">FILM</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">รหัสพนักงาน</label>
                        <input type="text" id="ot-employee-id-filter" placeholder="ค้นหารหัสพนักงาน" class="w-full border border-gray-300 rounded-lg p-2">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button id="search-ot-report-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <span class="material-symbols-outlined mr-2">search</span>ค้นหา
                    </button>
                    <button id="clear-ot-filters-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        <span class="material-symbols-outlined mr-2">clear</span>ล้างตัวกรอง
                    </button>
                </div>
            </div>

            <!-- Summary Section -->
            <div id="ot-summary-section" class="bg-white p-4 rounded-lg shadow-sm mb-4 hidden">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">สรุปข้อมูล OT</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600">จำนวนพนักงาน</p>
                                <p id="total-employees-count" class="text-2xl font-bold text-blue-800">0</p>
                            </div>
                            <span class="material-symbols-outlined text-blue-600 text-3xl">groups</span>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600">รวมชั่วโมง OT</p>
                                <p id="total-ot-hours" class="text-2xl font-bold text-green-800">0.0</p>
                            </div>
                            <span class="material-symbols-outlined text-green-600 text-3xl">schedule</span>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-orange-600">ค่าเฉลี่ยต่อคน</p>
                                <p id="average-ot-hours" class="text-2xl font-bold text-orange-800">0.0</p>
                            </div>
                            <span class="material-symbols-outlined text-orange-600 text-3xl">trending_up</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Table Section -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-800">รายละเอียดข้อมูล OT</h2>
                        <div class="flex gap-2">
                            <button id="export-ot-excel-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
                                <span class="material-symbols-outlined mr-2">download</span>Excel
                            </button>
                            <button id="print-ot-report-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center">
                                <span class="material-symbols-outlined mr-2">print</span>พิมพ์
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="ot-report-table" class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสพนักงาน</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แผนก</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ชั่วโมง OT</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody id="ot-report-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="ot-no-data" class="p-8 text-center text-gray-500 hidden">
                    <span class="material-symbols-outlined text-4xl mb-2">search_off</span>
                    <p>ไม่พบข้อมูล OT ในช่วงเวลาที่เลือก</p>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Attendance Report Container -->
    <div id="attendance-report-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <button id="back-to-reports-btn" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="กลับ">
                <span class="material-symbols-outlined text-gray-700">arrow_back</span>
            </button>
            <h1 class="text-xl font-bold text-gray-800">รายงานการเข้างาน</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28 overflow-y-auto">
            <!-- Date Selection -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-600">calendar_today</span>
                        <label class="font-medium text-gray-700">เลือกวันที่:</label>
                    </div>
                    <input type="date" id="report-date-picker" class="border border-gray-300 rounded-lg p-2 flex-1 sm:flex-none">
                    <button id="load-report-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <span class="material-symbols-outlined">search</span>
                        โหลดรายงาน
                    </button>
                </div>
            </div>

            <!-- Report Summary -->
            <div id="report-summary" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4 hidden">
                <div class="flex items-center gap-2 mb-3">
                    <span class="material-symbols-outlined text-green-600">summarize</span>
                    <h3 class="text-lg font-semibold text-gray-800">สรุปรายงาน</h3>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="total-leave-count">0</div>
                        <div class="text-sm text-gray-600">รวมคนลา</div>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="sick-leave-count">0</div>
                        <div class="text-sm text-gray-600">ลาป่วย</div>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600" id="personal-leave-count">0</div>
                        <div class="text-sm text-gray-600">ลากิจ</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="other-leave-count">0</div>
                        <div class="text-sm text-gray-600">อื่นๆ</div>
                    </div>
                </div>
            </div>

            <!-- Report Content -->
            <div id="report-content" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2 block">description</span>
                    <p>เลือกวันที่และกดโหลดรายงานเพื่อดูข้อมูลการลา</p>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- OT Report Container -->
    <div id="ot-report-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <button id="back-to-reports-from-ot-btn" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="กลับ">
                <span class="material-symbols-outlined text-gray-700">arrow_back</span>
            </button>
            <h1 class="text-xl font-bold text-gray-800">รายงาน OT</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28 overflow-y-auto">
            <!-- Filter Section -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-green-600">filter_alt</span>
                    <h3 class="text-lg font-semibold text-gray-800">ตัวกรองข้อมูล</h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Date Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เริ่มต้น</label>
                        <input type="date" id="ot-start-date" class="w-full border border-gray-300 rounded-lg p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่สิ้นสุด</label>
                        <input type="date" id="ot-end-date" class="w-full border border-gray-300 rounded-lg p-2">
                    </div>
                    <!-- Department Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">แผนก</label>
                        <select id="ot-department-filter" class="w-full border border-gray-300 rounded-lg p-2">
                            <option value="">ทุกแผนก</option>
                            <option value="Warehouse Manager">Warehouse Manager</option>
                            <option value="Assistant Warehouse Manager">Assistant Warehouse Manager</option>
                            <option value="A&I">A&I</option>
                            <option value="MH">MH</option>
                            <option value="SSRM">SSRM</option>
                            <option value="COIL">COIL</option>
                            <option value="FILM">FILM</option>
                        </select>
                    </div>
                    <!-- Employee Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">พนักงาน</label>
                        <select id="ot-employee-filter" class="w-full border border-gray-300 rounded-lg p-2">
                            <option value="">ทุกคน</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                    <button id="load-ot-report-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                        <span class="material-symbols-outlined">search</span>
                        โหลดรายงาน
                    </button>
                    <button id="export-ot-excel-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <span class="material-symbols-outlined">download</span>
                        ส่งออก Excel
                    </button>
                    <button id="print-ot-report-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2">
                        <span class="material-symbols-outlined">print</span>
                        พิมพ์รายงาน
                    </button>
                </div>
            </div>

            <!-- OT Summary -->
            <div id="ot-summary" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4 hidden">
                <div class="flex items-center gap-2 mb-3">
                    <span class="material-symbols-outlined text-green-600">summarize</span>
                    <h3 class="text-lg font-semibold text-gray-800">สรุป OT</h3>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="total-ot-hours">0</div>
                        <div class="text-sm text-gray-600">ชั่วโมง OT รวม</div>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="total-ot-employees">0</div>
                        <div class="text-sm text-gray-600">จำนวนพนักงาน</div>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600" id="avg-ot-hours">0</div>
                        <div class="text-sm text-gray-600">เฉลี่ย OT/คน</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="total-ot-days">0</div>
                        <div class="text-sm text-gray-600">วัน OT รวม</div>
                    </div>
                </div>
            </div>

            <!-- OT Report Table -->
            <div id="ot-report-content" class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-600">schedule</span>
                        <h3 class="text-lg font-semibold text-gray-800">รายละเอียด OT</h3>
                    </div>
                </div>
                <div id="ot-table-container" class="overflow-x-auto">
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2 block">schedule</span>
                        <p>เลือกช่วงวันที่และกดโหลดรายงานเพื่อดูข้อมูล OT</p>
                    </div>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Settings Container -->
    <div id="settings-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <div class="w-10"></div>
            <h1 class="text-xl font-bold text-gray-800">การตั้งค่า</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28">
            <div class="space-y-4">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">การตั้งค่าทั่วไป</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">การแจ้งเตือน</h4>
                                <p class="text-sm text-gray-600">เปิด/ปิดการแจ้งเตือนต่างๆ</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">โหมดมืด</h4>
                                <p class="text-sm text-gray-600">เปลี่ยนธีมของแอปพลิเคชัน</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ข้อมูลบริษัท</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อบริษัท</label>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-lg" value="TMT Steel Public Company Limited">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ที่อยู่</label>
                            <textarea class="w-full p-3 border border-gray-300 rounded-lg" rows="3">123 ถนนสุขุมวิท แขวงคลองตัน เขตคลองตัน กรุงเทพมหานคร 10110</textarea>
                        </div>
                        <button class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Help Container -->
    <div id="help-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <div class="w-10"></div>
            <h1 class="text-xl font-bold text-gray-800">ช่วยเหลือ</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28">
            <div class="space-y-4">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">คำถามที่พบบ่อย</h3>
                    <div class="space-y-4">
                        <div class="border-b border-gray-200 pb-4">
                            <h4 class="font-medium text-gray-800 mb-2">จะเพิ่มพนักงานใหม่ได้อย่างไร?</h4>
                            <p class="text-gray-600">ไปที่หน้าพนักงาน แล้วกดปุ่ม + ที่มุมล่างขวา กรอกข้อมูลพนักงานให้ครบถ้วน</p>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <h4 class="font-medium text-gray-800 mb-2">จะดูรายงานการเข้างานได้ที่ไหน?</h4>
                            <p class="text-gray-600">ไปที่เมนูเพิ่มเติม > รายงาน > รายงานการเข้างาน</p>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <h4 class="font-medium text-gray-800 mb-2">จะวางแผน OT ได้อย่างไร?</h4>
                            <p class="text-gray-600">ไปที่หน้าเช็คชื่อ แล้วเลือกวันที่ที่ต้องการวางแผน OT</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ติดต่อสนับสนุน</h3>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-blue-600 mr-3">email</span>
                            <div>
                                <p class="font-medium text-gray-800">อีเมล</p>
                                <p class="text-gray-600">support@tmtsteel.com</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-green-600 mr-3">phone</span>
                            <div>
                                <p class="font-medium text-gray-800">โทรศัพท์</p>
                                <p class="text-gray-600">02-123-4567</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-purple-600 mr-3">schedule</span>
                            <div>
                                <p class="font-medium text-gray-800">เวลาทำการ</p>
                                <p class="text-gray-600">จันทร์-ศุกร์ 8:00-17:00 น.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Calendar Page -->
    <div id="calendar-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 shadow-sm w-full flex-shrink-0" style="background-color: var(--orange-200);">
            <div class="w-10"></div>
            <h1 class="text-xl font-bold text-gray-800">ปฏิทินการลางาน</h1>
            <button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout">
                <span class="material-symbols-outlined text-gray-700">logout</span>
            </button>
        </header>
        <main class="flex-1 p-4 md:p-6 pb-28 overflow-y-auto">
            <!-- Calendar Header -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100">
                        <span class="material-symbols-outlined text-gray-600">chevron_left</span>
                    </button>
                    <h2 id="current-month-year" class="text-lg font-semibold text-gray-800"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-100">
                        <span class="material-symbols-outlined text-gray-600">chevron_right</span>
                    </button>
                </div>
                
                <!-- Calendar Grid -->
                <div class="p-4">
                    <!-- Days of week header -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-sm font-medium text-gray-500 py-2">อา</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">จ</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">อ</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">พ</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">พฤ</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">ศ</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">ส</div>
                    </div>
                    
                    <!-- Calendar days -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Days will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Leave Details Panel -->
            <div id="leave-details-panel" class="bg-white rounded-lg shadow-sm border border-gray-200 hidden">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">รายละเอียดการลา</h3>
                            <p id="selected-date" class="text-sm text-gray-600"></p>
                        </div>
                        <button id="close-leave-details" class="p-2 rounded-full hover:bg-gray-100">
                            <span class="material-symbols-outlined text-gray-600">close</span>
                        </button>
                    </div>
                </div>
                <div id="leave-details-content" class="p-4">
                    <!-- Leave details will be populated here -->
                </div>
            </div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0 fixed bottom-0 left-0 right-0 z-50">
            <nav class="flex justify-around border-t border-gray-200 py-2">
                <a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-xs font-medium">หน้าหลัก</p>
                </a>
                <a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">groups</span>
                    <p class="text-xs font-medium">พนักงาน</p>
                </a>
                <a href="#" data-page="attendance" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]">
                    <span class="material-symbols-outlined">checklist</span>
                    <p class="text-xs font-medium">เช็คชื่อ</p>
                </a>
                <a href="#" id="more-menu-btn" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold cursor-pointer">
                    <span class="material-symbols-outlined">more_horiz</span>
                    <p class="text-xs font-medium">เพิ่มเติม</p>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Leave Type Selection Modal -->
    <div id="leave-type-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">เลือกประเภทการลา</h3>
                <div id="leave-options-container" class="grid grid-cols-2 gap-3 mt-4">
                    <!-- Buttons will be injected here -->
                </div>
                 <button id="cancel-leave-selection-btn" class="mt-4 w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- More Menu Modal -->
    <div id="more-menu-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div id="more-menu-content" class="bg-white w-full transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95">
            <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">เมนูเพิ่มเติม</h3>
                    <button id="close-more-menu" class="p-2 rounded-full hover:bg-gray-100">
                        <span class="material-symbols-outlined text-gray-600">close</span>
                    </button>
                </div>
                <div class="space-y-2">
                    <a href="#" data-page="shift-management" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">schedule_send</span>
                        <div>
                            <p class="font-medium text-gray-800">จัดการเข้ากะ</p>
                            <p class="text-sm text-gray-500">กำหนดกะการทำงานของพนักงาน</p>
                        </div>
                    </a>
                    <a href="#" data-page="shift-schedule" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">calendar_view_week</span>
                        <div>
                            <p class="font-medium text-gray-800">ตารางกะ</p>
                            <p class="text-sm text-gray-500">ดูและจัดการตารางกะรายวัน</p>
                        </div>
                    </a>
                    <a href="#" data-page="ot-plan" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">schedule</span>
                        <div>
                            <p class="font-medium text-gray-800">Plan OT</p>
                            <p class="text-sm text-gray-500">วางแผนการทำงานล่วงเวลา</p>
                        </div>
                    </a>
                    <a href="#" data-page="calendar" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">calendar_month</span>
                        <div>
                            <p class="font-medium text-gray-800">ปฏิทิน</p>
                            <p class="text-sm text-gray-500">ดูข้อมูลการลางานรายวัน</p>
                        </div>
                    </a>
                    <a href="#" data-page="reports" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">assessment</span>
                        <div>
                            <p class="font-medium text-gray-800">รายงาน</p>
                            <p class="text-sm text-gray-500">ดูรายงานต่างๆ</p>
                        </div>
                    </a>
                    <a href="#" data-page="ot-report" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">schedule</span>
                        <div>
                            <p class="font-medium text-gray-800">รายงาน OT</p>
                            <p class="text-sm text-gray-500">สรุปชั่วโมงทำงานล่วงเวลาของพนักงาน</p>
                        </div>
                    </a>
                    <a href="#" data-page="settings" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">settings</span>
                        <div>
                            <p class="font-medium text-gray-800">การตั้งค่า</p>
                            <p class="text-sm text-gray-500">จัดการการตั้งค่าระบบ</p>
                        </div>
                    </a>
                    <a href="#" data-page="help" class="more-menu-item flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="material-symbols-outlined text-[var(--primary-600)] mr-3">help</span>
                        <div>
                            <p class="font-medium text-gray-800">ช่วยเหลือ</p>
                            <p class="text-sm text-gray-500">คู่มือการใช้งาน</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global utility functions
        const showMessage = (message, isError = false) => {
            if (isError) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: message,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444'
                });
            } else {
                Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ',
                    text: message,
                    timer: 1500,
                    showConfirmButton: false,
                    timerProgressBar: true
                });
            }
        };

        // Global configuration
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwCjCZSLwe4n688I24ecEIDauCjlVNsrCqcPHyOf7Bv3wT5unbPwjgWgoADzuMcWP7Axg/exec';

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            // Use UTC to prevent timezone shift issues
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('th-TH', options);
        };


        document.addEventListener('DOMContentLoaded', () => {

            // State variables
            let isEditMode = false;
            let editingEmployeeId = null;
            let photoBase64 = null;
            let employeeIdToDelete = null;
            let currentEditingLeaveEmployeeCard = null;
            let currentPage = 'login'; // Track current page
            let calendarLeaveData = {};
            
            // Data Caching System
            let dataCache = {
                employees: null,
                employeesTimestamp: null,
                attendance: {},
                otPlan: {},
                shiftAssignments: {},
                calendarData: null,
                calendarTimestamp: null
            };
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
            
            // Page initialization tracking for lazy loading
            const pageInitialized = {
                'employee-list': false,
                'ot-plan': false,
                'attendance': false,
                'calendar': false,
                'shift-management': false,
                'ot-report': false
            };
            
            // Shift Management Variables
            let selectedShiftType = null; // 'morning' or 'night'
            let selectedShiftWeek = null;
            let selectedShiftTime = null;
            let shiftEmployeeData = [];
            let currentShiftAssignments = {};
            
            // More Menu Modal Elements
            const moreMenuModal = document.getElementById('more-menu-modal');
            const moreMenuContent = document.getElementById('more-menu-content');
            const moreMenuBtns = document.querySelectorAll('#more-menu-btn');
            const closeMoreMenuBtn = document.getElementById('close-more-menu');
            
            // Wrappers & Containers
            const containers = {
                auth: document.getElementById('auth-wrapper'),
                register: document.getElementById('register-container'),
                login: document.getElementById('login-container'),
                home: document.getElementById('home-container'),
                employeeList: document.getElementById('employee-list-container'),
                addEmployee: document.getElementById('add-employee-container'),
                shiftManagement: document.getElementById('shift-management-container'),
                shiftSchedule: document.getElementById('shift-schedule-container'),
                otPlan: document.getElementById('ot-plan-container'),
                attendance: document.getElementById('attendance-container'),
                calendar: document.getElementById('calendar-container'),
                reports: document.getElementById('reports-container'), 
                attendanceReport: document.getElementById('attendance-report-container'),
                leaveReport: document.getElementById('leave-report-container'),
                otReport: document.getElementById('ot-report-container'),
                settings: document.getElementById('settings-container'), 
                help: document.getElementById('help-container')
            };
            
            const createDepartmentTabs = () => {
                if (!departmentTabs || availableDepartments.length === 0) return;
                
                const tabContainer = departmentTabs.querySelector('.flex');
                tabContainer.innerHTML = '';
                
                // Add "All" tab
                const allTab = document.createElement('button');
                allTab.className = `department-tab ${
                    selectedDepartment === 'all' ? 'active' : ''
                }`;
                allTab.textContent = 'ทั้งหมด';
                allTab.onclick = () => selectDepartment('all');
                tabContainer.appendChild(allTab);
                
                // Add department tabs
                availableDepartments.forEach(dept => {
                    const tab = document.createElement('button');
                    tab.className = `department-tab ${
                        selectedDepartment === dept ? 'active' : ''
                    }`;
                    tab.textContent = dept;
                    tab.onclick = () => selectDepartment(dept);
                    tabContainer.appendChild(tab);
                });
                
                departmentTabs.classList.remove('hidden');
            };
            
            const selectDepartment = (dept) => {
                selectedDepartment = dept;
                createDepartmentTabs(); // Refresh tab styles
                renderShiftEmployeeList();
            };
            
            // Forms, Inputs, etc.
            const registerForm = document.getElementById('register-form');
            const loginForm = document.getElementById('login-form');
            const employeeForm = document.getElementById('employee-form');
            const photoUploadInput = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const employeeListMain = document.getElementById('employee-list-main');
            const employeeFormTitle = document.getElementById('employee-form-title');
            const saveEmployeeButtonSpan = document.getElementById('save-employee-button').querySelector('span');
            const otDatePicker = document.getElementById('ot-date-picker');
            const attendanceDatePicker = document.getElementById('attendance-date-picker');
            const leaveTypeModal = document.getElementById('leave-type-modal');
            const leaveOptionsContainer = document.getElementById('leave-options-container');
            const cancelLeaveSelectionBtn = document.getElementById('cancel-leave-selection-btn');
            const attendanceTabs = document.getElementById('attendance-tabs');
            const attendanceTabContent = document.getElementById('attendance-tab-content');
            const otPlanTabs = document.getElementById('ot-plan-tabs');
            const otPlanTabContent = document.getElementById('ot-plan-tab-content');
            
            // Shift Management Elements
            const morningShiftBtn = document.getElementById('morning-shift-btn');
            const nightShiftBtn = document.getElementById('night-shift-btn');
            const weekStartPicker = document.getElementById('week-start-picker');
            const weekDisplay = document.getElementById('week-display');
            const weekRange = document.getElementById('week-range');
            const shiftEmployeeList = document.getElementById('shift-employee-list');
            const saveShiftAssignmentBtn = document.getElementById('save-shift-btn');
            const departmentTabs = document.getElementById('department-tabs');
            
            // Shift Management Variables
            let shiftEmployeesByDepartment = {};
            let selectedDepartment = 'all';
            let availableDepartments = [];
            let selectedWeekStart = null;
            let selectedWeekEnd = null;
            

            

            // --- FUNCTIONS ---
            const resetEmployeeForm = () => {
                isEditMode = false;
                editingEmployeeId = null;
                employeeFormTitle.textContent = 'เพิ่มข้อมูลพนักงาน';
                employeeForm.reset();
                document.getElementById('employee-id').readOnly = false;
                photoPreview.src = 'https://placehold.co/128x128/EFEFEF/AAAAAA?text=Photo';
                photoBase64 = null;
                photoUploadInput.value = '';
                saveEmployeeButtonSpan.textContent = 'บันทึก';
            };

            // Data Caching Helper Functions
            const isCacheValid = (timestamp) => {
                return timestamp && (Date.now() - timestamp) < CACHE_DURATION;
            };

            // Debug function to clear cache and reload data
            window.clearCacheAndReload = () => {
                invalidateCache('all');
                console.log('Cache cleared. Reloading current page data...');
                if (currentPage === 'employee-list') {
                    fetchAndDisplayEmployees();
                } else if (currentPage === 'shift-management') {
                    loadShiftEmployees();
                }
            };

            // Fix Google Drive URL to avoid CORB errors
            const fixGoogleDriveUrl = (url) => {
                // Temporarily disabled - keeping original URLs that work
                return url;
                
                /* Original conversion code - disabled for now
                if (!url) return url;
                
                // Convert old googleusercontent.com URLs to drive.google.com format
                const googleUserContentMatch = url.match(/https:\/\/lh3\.googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/);
                if (googleUserContentMatch) {
                    const fileId = googleUserContentMatch[1];
                    return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
                
                return url;
                */
            };

            const getCachedEmployees = async () => {
                if (dataCache.employees && isCacheValid(dataCache.employeesTimestamp)) {
                    // Fix Google Drive URLs in cached data too
                    const fixedData = dataCache.employees.map(emp => ({
                        ...emp,
                        photoUrl: fixGoogleDriveUrl(emp.photoUrl)
                    }));
                    return { status: 'success', data: fixedData, fromCache: true };
                }
                
                try {
                    const response = await fetch(`${GAS_URL}?action=getEmployees`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Fix Google Drive URLs to avoid CORB errors
                        result.data = result.data.map(emp => ({
                            ...emp,
                            photoUrl: fixGoogleDriveUrl(emp.photoUrl)
                        }));
                        
                        dataCache.employees = result.data;
                        dataCache.employeesTimestamp = Date.now();
                    }
                    
                    return result;
                } catch (error) {
                    console.error('Error fetching employees:', error);
                    return { status: 'error', message: 'เกิดข้อผิดพลาดในการเชื่อมต่อ' };
                }
            };

            const getCachedAttendance = async (date) => {
                const cacheKey = date;
                if (dataCache.attendance[cacheKey] && isCacheValid(dataCache.attendance[cacheKey].timestamp)) {
                    return { status: 'success', data: dataCache.attendance[cacheKey].data, fromCache: true };
                }
                
                try {
                    const response = await fetch(`${GAS_URL}?action=getAttendance&date=${date}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        dataCache.attendance[cacheKey] = {
                            data: result.data,
                            timestamp: Date.now()
                        };
                    }
                    
                    return result;
                } catch (error) {
                    console.error('Error fetching attendance:', error);
                    return { status: 'error', message: 'เกิดข้อผิดพลาดในการเชื่อมต่อ' };
                }
            };

            const getCachedOtPlan = async (date) => {
                const cacheKey = date;
                if (dataCache.otPlan[cacheKey] && isCacheValid(dataCache.otPlan[cacheKey].timestamp)) {
                    return { status: 'success', data: dataCache.otPlan[cacheKey].data, fromCache: true };
                }
                
                try {
                    const response = await fetch(`${GAS_URL}?action=getOtPlan&date=${date}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        dataCache.otPlan[cacheKey] = {
                            data: result.data,
                            timestamp: Date.now()
                        };
                    }
                    
                    return result;
                } catch (error) {
                    console.error('Error fetching OT plan:', error);
                    return { status: 'error', message: 'เกิดข้อผิดพลาดในการเชื่อมต่อ' };
                }
            };

            const invalidateCache = (type = 'all') => {
                if (type === 'all' || type === 'employees') {
                    dataCache.employees = null;
                    dataCache.employeesTimestamp = null;
                    // Also invalidate related pages
                    pageInitialized['employee-list'] = false;
                    pageInitialized['shift-management'] = false;
                }
                if (type === 'all' || type === 'attendance') {
                    dataCache.attendance = {};
                    pageInitialized['attendance'] = false;
                }
                if (type === 'all' || type === 'otPlan') {
                    dataCache.otPlan = {};
                    pageInitialized['ot-plan'] = false;
                }
                if (type === 'all' || type === 'calendar') {
                    dataCache.calendarData = null;
                    dataCache.calendarTimestamp = null;
                    pageInitialized['calendar'] = false;
                }
                if (type === 'all') {
                    // Reset all page initialization flags
                    Object.keys(pageInitialized).forEach(key => {
                        pageInitialized[key] = false;
                    });
                }
            };

            const openEditEmployeeForm = (emp) => {
                isEditMode = true;
                editingEmployeeId = emp.employeeId;
                employeeFormTitle.textContent = 'แก้ไขข้อมูลพนักงาน';

                document.getElementById('full-name').value = emp.fullName || '';
                document.getElementById('employee-id').value = emp.employeeId || '';
                document.getElementById('employee-id').readOnly = true;
                document.getElementById('department').value = emp.department || '';
                document.getElementById('position').value = emp.position || '';
                document.getElementById('role').value = emp.role || 'User';
                
                try {
                    document.getElementById('start-date').value = emp.startDate ? new Date(emp.startDate).toISOString().split('T')[0] : '';
                } catch(e){
                    document.getElementById('start-date').value = '';
                }

                photoPreview.src = emp.photoUrl || 'https://placehold.co/128x128/EFEFEF/AAAAAA?text=Photo';
                photoBase64 = null; 

                saveEmployeeButtonSpan.textContent = 'อัปเดต';
                toggleView('add-employee');
            };

            const openDeleteConfirmation = (emp) => {
                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: `คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลของ ${emp.fullName}? การกระทำนี้ไม่สามารถย้อนกลับได้`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ยืนยันการลบ',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        employeeIdToDelete = emp.employeeId;
                        handleDelete();
                    }
                });
            };
            
            const handleDelete = async () => {
                if (!employeeIdToDelete) return;

                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'deleteEmployee',
                            employeeId: employeeIdToDelete
                        })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('ลบข้อมูลพนักงานเรียบร้อยแล้ว');
                        fetchAndDisplayEmployees();
                    } else {
                        showMessage(result.message, true);
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการลบข้อมูล', true);
                } finally {
                   employeeIdToDelete = null;
                }
            };

            const renderEmployeeList = (employees) => {
                employeeListMain.innerHTML = '';
                if (!employees || employees.length === 0) {
                    employeeListMain.innerHTML = `<p class="text-center text-gray-500 mt-8">ยังไม่มีข้อมูลพนักงาน</p>`;
                    return;
                }

                const groupedByDept = employees.reduce((acc, emp) => {
                    const dept = emp.department || 'ไม่ระบุส่วนงาน';
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(emp);
                    return acc;
                }, {});

                for (const dept in groupedByDept) {
                    const deptContainer = document.createElement('div');
                    deptContainer.className = 'mb-6';
                    
                    const deptHeader = document.createElement('h2');
                    deptHeader.className = 'text-lg font-bold text-gray-700 mb-3 px-2';
                    deptHeader.textContent = dept;
                    deptContainer.appendChild(deptHeader);

                    const grid = document.createElement('div');
                    grid.className = 'space-y-3';
                    
                    groupedByDept[dept].forEach(emp => {
                        const card = document.createElement('div');
                        card.className = 'flex items-center bg-white p-3 rounded-xl shadow-sm space-x-4';
                        const photoSrc = emp.photoUrl || 'https://placehold.co/64x64/EFEFEF/AAAAAA?text=No+Img';
                        
                        // คำนวณอายุงาน
                        const calculateWorkExperience = (startDate) => {
                            if (!startDate) return 'ไม่ระบุ';
                            const start = new Date(startDate);
                            const now = new Date();
                            if (isNaN(start.getTime())) return 'ไม่ระบุ';
                            const diffTime = Math.abs(now - start);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            const years = Math.floor(diffDays / 365);
                            const months = Math.floor((diffDays % 365) / 30);
                            
                            let result = '';
                            if(years > 0) result += `${years} ปี `;
                            if(months > 0) result += `${months} เดือน`;
                            
                            return result.trim() || 'น้อยกว่า 1 เดือน';
                        };
                        
                        const workExperience = calculateWorkExperience(emp.startDate);
                        
                        card.innerHTML = `
                            <img src="${photoSrc}" alt="${emp.fullName}" class="w-16 h-16 rounded-full object-cover bg-gray-200" onerror="this.src='https://placehold.co/64x64/EFEFEF/AAAAAA?text=Error'">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">${emp.fullName}</p>
                                <p class="text-sm text-gray-500">${emp.position || '-'}</p>
                                <p class="text-xs text-gray-400 mt-1">ID: ${emp.employeeId} | Role: ${emp.role || 'User'}</p>
                                <p class="text-xs text-blue-600 mt-1">อายุงาน: ${workExperience}</p>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button class="edit-employee-btn p-2 rounded-full hover:bg-gray-100 transition-colors">
                                    <span class="material-symbols-outlined text-gray-600">edit</span>
                                </button>
                                <button class="delete-employee-btn p-2 rounded-full hover:bg-red-100 transition-colors">
                                    <span class="material-symbols-outlined text-red-500">delete</span>
                                </button>
                            </div>
                        `;
                        card.querySelector('.edit-employee-btn').addEventListener('click', () => openEditEmployeeForm(emp));
                        card.querySelector('.delete-employee-btn').addEventListener('click', () => openDeleteConfirmation(emp));
                        grid.appendChild(card);
                    });

                    deptContainer.appendChild(grid);
                    employeeListMain.appendChild(deptContainer);
                }
            };

            const fetchAndDisplayEmployees = async () => {
                employeeListMain.innerHTML = `<p class="text-center text-gray-500 mt-8">กำลังโหลดข้อมูล...</p>`;
                try {
                    const result = await getCachedEmployees();
                    if (result.status === 'success') {
                        renderEmployeeList(result.data);
                        if (result.fromCache) {
                            console.log('Employee data loaded from cache');
                        }
                    } else {
                        showMessage(result.message, true);
                        employeeListMain.innerHTML = `<p class="text-center text-red-500 mt-8">ไม่สามารถโหลดข้อมูลได้</p>`;
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', true);
                    employeeListMain.innerHTML = `<p class="text-center text-red-500 mt-8">เกิดข้อผิดพลาดในการเชื่อมต่อ</p>`;
                }
            };
            
            // --- Attendance Functions ---
             const openLeaveModal = (card) => {
                currentEditingLeaveEmployeeCard = card;
                const leaveTypes = ['ลาป่วย', 'ลากิจ', 'ลาพักร้อน', 'ลงบวช', 'ลาแต่งงาน'];
                leaveOptionsContainer.innerHTML = leaveTypes.map(lt => 
                    `<button type="button" data-leave-type="${lt}" class="leave-option-btn w-full p-3 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">${lt}</button>`
                ).join('');
                leaveTypeModal.classList.remove('hidden');
                leaveTypeModal.classList.add('flex');
            };

            const closeLeaveModal = () => {
                currentEditingLeaveEmployeeCard = null;
                leaveTypeModal.classList.add('hidden');
                leaveTypeModal.classList.remove('flex');
            };
            
            const initializeAttendancePage = () => {
                const today = new Date().toISOString().split('T')[0];
                attendanceDatePicker.value = today;
                fetchDataForAttendance(today);
            };

            const fetchDataForAttendance = async (date) => {
                attendanceTabs.innerHTML = `<p class="p-4 text-gray-500">กำลังโหลด...</p>`;
                attendanceTabContent.innerHTML = '';
                try {
                    const [empResult, attendanceResult] = await Promise.all([
                        getCachedEmployees(),
                        getCachedAttendance(date)
                    ]);

                    if (empResult.status === 'success') {
                        const existingRecords = attendanceResult.status === 'success' ? attendanceResult.data : [];
                        renderAttendanceList(empResult.data, existingRecords);
                        
                        if (empResult.fromCache || attendanceResult.fromCache) {
                            console.log('Attendance data loaded from cache');
                        }
                    } else {
                        showMessage(empResult.message, true);
                        attendanceTabs.innerHTML = `<p class="p-4 text-red-500">ไม่สามารถโหลดข้อมูลพนักงานได้</p>`;
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', true);
                    attendanceTabs.innerHTML = `<p class="p-4 text-red-500">เกิดข้อผิดพลาดในการเชื่อมต่อ</p>`;
                }
            };
            
            const renderAttendanceList = (employees, existingRecords) => {
                attendanceTabs.innerHTML = '';
                attendanceTabContent.innerHTML = '';
                if (!employees || employees.length === 0) {
                    attendanceTabs.innerHTML = `<p class="p-4 text-gray-500">ยังไม่มีข้อมูลพนักงาน</p>`;
                    return;
                }

                const recordMap = existingRecords.reduce((acc, record) => {
                    acc[record.employeeId] = record;
                    return acc;
                }, {});

                const groupedByDept = employees.reduce((acc, emp) => {
                    const dept = emp.department || 'ไม่ระบุส่วนงาน';
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(emp);
                    return acc;
                }, {});
                
                const leaveTypes = ['ลาป่วย', 'ลากิจ', 'ลาพักร้อน', 'ลงบวช', 'ลาแต่งงาน'];
                let isFirstTab = true;

                for (const dept in groupedByDept) {
                    // Create Tab Button
                    const tabButton = document.createElement('button');
                    tabButton.className = `tab-btn px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap`;
                    tabButton.textContent = dept;
                    tabButton.dataset.department = dept;
                    if (isFirstTab) tabButton.classList.add('active');
                    attendanceTabs.appendChild(tabButton);

                    // Create Tab Content Pane
                    const deptContainer = document.createElement('div');
                    deptContainer.className = 'tab-pane';
                    if (!isFirstTab) deptContainer.classList.add('hidden');
                    deptContainer.dataset.departmentContent = dept;

                    const deptHeader = document.createElement('div');
                    deptHeader.className = 'flex justify-between items-center p-4 bg-gray-100 rounded-t-lg';
                    deptHeader.innerHTML = `
                        <h3 class="text-md font-bold text-gray-800">${dept}</h3>
                        <div class="flex items-center gap-2">
                            <button type="button" class="dept-reset-attendance-btn bg-gray-500 text-white px-3 py-1 rounded text-xs hover:bg-gray-600 transition-colors" data-department="${dept}">
                                รีเซต
                            </button>
                             <button type="button" class="dept-save-attendance-btn bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition-colors" data-department="${dept}">
                                บันทึก
                            </button>
                        </div>
                    `;
                    deptContainer.appendChild(deptHeader);
                    
                    const list = document.createElement('div');
                    list.className = 'divide-y bg-white rounded-b-lg shadow-sm';

                    groupedByDept[dept].forEach(emp => {
                        const record = recordMap[emp.employeeId] || {};
                        const card = document.createElement('div');
                        card.className = 'p-4';
                        card.dataset.employeeId = emp.employeeId;
                        
                        const currentStatus = record.status || 'มาทำงาน';
                        card.dataset.currentStatus = currentStatus;

                        const mainStatusTypes = ['มาทำงาน', 'ลา', 'ขาดงาน', 'ลาออก', 'สาย/Meeting'];
                        
                        let displayStatus = currentStatus;
                        let isLeave = false;
                        if(leaveTypes.includes(currentStatus)){
                            displayStatus = 'ลา';
                            isLeave = true;
                        }

                        const statusButtons = mainStatusTypes.map(s => {
                            let text = s;
                            if(s === 'ลา' && isLeave){ text = currentStatus; }
                            const isActive = (s === displayStatus);
                            return `<button type="button" data-main-status="${s}" class="status-btn px-2 py-1 text-xs rounded transition-colors ${isActive ? 'active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">${text}</button>`
                        }).join('');

                        card.innerHTML = `
                            <div class="flex items-start space-x-4">
                               <img src="${emp.photoUrl || 'https://placehold.co/48x48/EFEFEF/AAAAAA?text=No+Img'}" alt="${emp.fullName}" class="w-12 h-12 rounded-full object-cover bg-gray-200" onerror="this.src='https://placehold.co/48x48/EFEFEF/AAAAAA?text=Error'">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">${emp.fullName}</p>
                                    <p class="text-sm text-gray-500">${emp.employeeId}</p>
                                </div>
                            </div>
                            <div class="attendance-details pl-16 mt-2 space-y-2">
                               <div class="attendance-status-buttons flex flex-wrap gap-1">
                                    ${statusButtons}
                               </div>
                               <input type="text" class="attendance-reason w-full border border-gray-300 rounded p-2 text-sm ${currentStatus === 'มาทำงาน' ? 'hidden' : ''}" placeholder="ระบุเหตุผล (ถ้ามี)" value="${record.reason || ''}">
                            </div>
                        `;
                        list.appendChild(card);
                    });
                     deptContainer.appendChild(list);
                     attendanceTabContent.appendChild(deptContainer);
                     isFirstTab = false;
                }

                // Delegated event listeners for tabs and actions
                attendanceTabs.addEventListener('click', (e) => {
                    const tabButton = e.target.closest('.tab-btn');
                    if(tabButton){
                        attendanceTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabButton.classList.add('active');
                        
                        attendanceTabContent.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                        attendanceTabContent.querySelector(`[data-department-content="${tabButton.dataset.department}"]`).classList.remove('hidden');
                    }
                });
                
                attendanceTabContent.addEventListener('click', (e) => {
                    const button = e.target.closest('.status-btn, .dept-reset-attendance-btn, .dept-save-attendance-btn');
                    if (!button) return;

                    if (button.classList.contains('status-btn')) {
                        const card = button.closest('[data-employee-id]');
                        const mainStatus = button.dataset.mainStatus;

                        if (mainStatus === 'ลา') {
                            openLeaveModal(card);
                        } else {
                            card.dataset.currentStatus = mainStatus;
                            const buttonGroup = button.parentElement;
                            const reasonInput = card.querySelector('.attendance-reason');

                            buttonGroup.querySelectorAll('.status-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                                if(btn.dataset.mainStatus === 'ลา') btn.textContent = 'ลา';
                            });
                            button.classList.add('active');
                            button.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');

                             if (mainStatus === 'มาทำงาน') {
                                reasonInput.classList.add('hidden');
                                reasonInput.value = '';
                            } else {
                                reasonInput.classList.remove('hidden');
                            }
                        }
                    }

                    if (button.classList.contains('dept-reset-attendance-btn')) {
                        const deptContainer = button.closest('.tab-pane');
                        deptContainer.querySelectorAll('[data-employee-id]').forEach(card => {
                            card.dataset.currentStatus = 'มาทำงาน';
                            const buttonGroup = card.querySelector('.attendance-status-buttons');
                            const reasonInput = card.querySelector('.attendance-reason');
                            
                            buttonGroup.querySelectorAll('.status-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                                if (btn.dataset.mainStatus === 'มาทำงาน') {
                                    btn.classList.add('active');
                                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                                }
                                if(btn.dataset.mainStatus === 'ลา') btn.textContent = 'ลา';
                            });
                            reasonInput.classList.add('hidden');
                            reasonInput.value = '';
                        });
                         showMessage(`รีเซตข้อมูล ${button.dataset.department} เรียบร้อยแล้ว`);
                    }
                    
                    if (button.classList.contains('dept-save-attendance-btn')) {
                        const department = button.dataset.department;
                        handleSaveAttendance(department, button);
                    }
                });
                
                leaveOptionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.leave-option-btn');
                    if (button && currentEditingLeaveEmployeeCard) {
                        const selectedLeaveType = button.dataset.leaveType;
                        currentEditingLeaveEmployeeCard.dataset.currentStatus = selectedLeaveType;

                        const buttonGroup = currentEditingLeaveEmployeeCard.querySelector('.attendance-status-buttons');
                        const reasonInput = currentEditingLeaveEmployeeCard.querySelector('.attendance-reason');

                        buttonGroup.querySelectorAll('.status-btn').forEach(btn => {
                             btn.classList.remove('active');
                             btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                        });

                        const leaveBtn = buttonGroup.querySelector('[data-main-status="ลา"]');
                        if(leaveBtn){
                             leaveBtn.classList.add('active');
                             leaveBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                             leaveBtn.textContent = selectedLeaveType;
                        }
                        
                        reasonInput.classList.remove('hidden');
                        closeLeaveModal();
                    }
                });
                cancelLeaveSelectionBtn.addEventListener('click', closeLeaveModal);
            };
            
            const handleSaveAttendance = async (departmentToSave, button) => {
                const date = attendanceDatePicker.value;
                if(!date) { showMessage('กรุณาเลือกวันที่', true); return; }

                const records = [];
                const deptContainer = document.querySelector(`[data-department-content="${departmentToSave}"]`);
                if(deptContainer){
                    deptContainer.querySelectorAll('[data-employee-id]').forEach(card => {
                        records.push({
                            employeeId: card.dataset.employeeId,
                            status: card.dataset.currentStatus || 'มาทำงาน',
                            reason: card.querySelector('.attendance-reason').value
                        });
                    });
                }

                if(records.length === 0) {
                     showMessage('ไม่มีข้อมูลให้บันทึก', true);
                     return;
                }

                button.disabled = true;
                button.textContent = 'กำลังบันทึก...';
                
                try {
                     const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'saveAttendance',
                            data: { date, records }
                        })
                    });
                    const result = await response.json();
                    if(result.status === 'success') {
                        showMessage(`บันทึกข้อมูลส่วนงาน ${departmentToSave} เรียบร้อยแล้ว`);
                    } else {
                        showMessage(result.message, true);
                    }
                } catch(error) {
                    showMessage('เกิดข้อผิดพลาดในการบันทึก', true);
                } finally {
                    button.disabled = false;
                    button.textContent = 'บันทึก';
                }
            };
            
            attendanceDatePicker.addEventListener('change', () => fetchDataForAttendance(attendanceDatePicker.value));
            
            // --- Attendance Report Functions ---
            const initializeAttendanceReport = () => {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('report-date-picker').value = today;
                document.getElementById('report-summary').classList.add('hidden');
                
                // แสดง loading และโหลดข้อมูลจริงของวันปัจจุบัน
                document.getElementById('report-content').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2 block animate-spin">refresh</span>
                        <p>กำลังโหลดข้อมูลรายงานการเข้างานของวันที่ ${formatThaiDate(today)}...</p>
                    </div>
                `;
                
                // โหลดข้อมูลจริงทันทีเมื่อเข้าหน้า
                loadAttendanceReport();
            };
            
            const loadAttendanceReport = async () => {
                const date = document.getElementById('report-date-picker').value;
                if (!date) {
                    showMessage('กรุณาเลือกวันที่', true);
                    return;
                }
                
                try {
                    // แสดง loading
                    document.getElementById('report-content').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2 block animate-spin">refresh</span>
                            <p>กำลังโหลดข้อมูล...</p>
                        </div>
                    `;
                    
                    // ดึงข้อมูลพนักงานและการเข้างาน
                    const [empResponse, attendanceResponse] = await Promise.all([
                        fetch(`${GAS_URL}?action=getEmployees`),
                        fetch(`${GAS_URL}?action=getAttendance&date=${date}`)
                    ]);
                    
                    const empResult = await empResponse.json();
                    const attendanceResult = await attendanceResponse.json();
                    
                    if (empResult.status !== 'success') {
                        throw new Error('ไม่สามารถโหลดข้อมูลพนักงานได้');
                    }
                    
                    const employees = empResult.data;
                    const attendanceRecords = attendanceResult.status === 'success' ? attendanceResult.data : [];
                    
                    // สร้าง map ของข้อมูลการเข้างาน
                    const attendanceMap = attendanceRecords.reduce((acc, record) => {
                        acc[record.employeeId] = record;
                        return acc;
                    }, {});
                    
                    // กรองเฉพาะคนที่ลา (ไม่ใช่ มาทำงาน และ สาย/Meeting)
                    const leaveEmployees = employees.filter(emp => {
                        const attendance = attendanceMap[emp.employeeId];
                        return attendance && attendance.status !== 'มาทำงาน' && attendance.status !== 'สาย/Meeting';
                    }).map(emp => ({
                        ...emp,
                        attendance: attendanceMap[emp.employeeId]
                    }));
                    
                    renderAttendanceReport(leaveEmployees, date);
                    
                } catch (error) {
                    console.error('Error loading attendance report:', error);
                    
                    // แสดงข้อมูลทดสอบเมื่อไม่สามารถเชื่อมต่อได้
                    const testData = [
                        {
                            employeeId: 'EMP001',
                            fullName: 'สมชาย ใจดี',
                            department: 'IT',
                            photoUrl: 'https://placehold.co/40x40/4F46E5/FFFFFF?text=SC',
                            attendance: {
                                status: 'ลาป่วย',
                                reason: 'ไข้หวัด'
                            }
                        },
                        {
                            employeeId: 'EMP002',
                            fullName: 'สมหญิง รักงาน',
                            department: 'HR',
                            photoUrl: 'https://placehold.co/40x40/EC4899/FFFFFF?text=SH',
                            attendance: {
                                status: 'ลากิจ',
                                reason: 'ธุระส่วนตัว'
                            }
                        },
                        {
                            employeeId: 'EMP003',
                            fullName: 'สมศักดิ์ ขยันทำงาน',
                            department: 'IT',
                            photoUrl: 'https://placehold.co/40x40/10B981/FFFFFF?text=SS',
                            attendance: {
                                status: 'ลาพักร้อน',
                                reason: 'เที่ยวกับครอบครัว'
                            }
                        }
                    ];
                    
                    // แสดงข้อความแจ้งเตือนและข้อมูลทดสอบ
                    document.getElementById('report-content').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="material-symbols-outlined text-yellow-600">warning</span>
                                <h4 class="font-medium text-yellow-800">ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้</h4>
                            </div>
                            <p class="text-yellow-700 text-sm mb-2">กำลังแสดงข้อมูลตัวอย่างเพื่อการทดสอบ</p>
                            <p class="text-yellow-600 text-xs">ข้อผิดพลาด: ${error.message}</p>
                        </div>
                    `;
                    
                    renderAttendanceReport(testData, date);
                }
            };
            
            const renderAttendanceReport = (leaveEmployees, date) => {
                // คำนวณสถิติ
                const stats = {
                    total: leaveEmployees.length,
                    sick: leaveEmployees.filter(emp => emp.attendance.status === 'ลาป่วย').length,
                    personal: leaveEmployees.filter(emp => emp.attendance.status === 'ลากิจ').length,
                    other: leaveEmployees.filter(emp => !['ลาป่วย', 'ลากิจ'].includes(emp.attendance.status)).length
                };
                
                // อัปเดตสรุป
                document.getElementById('total-leave-count').textContent = stats.total;
                document.getElementById('sick-leave-count').textContent = stats.sick;
                document.getElementById('personal-leave-count').textContent = stats.personal;
                document.getElementById('other-leave-count').textContent = stats.other;
                document.getElementById('report-summary').classList.remove('hidden');
                
                if (leaveEmployees.length === 0) {
                    document.getElementById('report-content').innerHTML = `
                        <div class="text-center py-8 text-green-600">
                            <span class="material-symbols-outlined text-4xl mb-2 block">check_circle</span>
                            <p class="text-lg font-medium">ไม่มีพนักงานลาในวันที่ ${formatThaiDate(date)}</p>
                            <p class="text-sm">พนักงานทุกคนมาทำงานครบ</p>
                        </div>
                    `;
                    return;
                }
                
                // จัดกลุ่มตามแผนก
                const departmentGroups = leaveEmployees.reduce((acc, emp) => {
                    const dept = emp.department || 'ไม่ระบุแผนก';
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(emp);
                    return acc;
                }, {});
                
                // สร้าง HTML
                let reportHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">รายงานการลาวันที่ ${formatThaiDate(date)}</h3>
                        <p class="text-gray-600">พบพนักงานลา ${leaveEmployees.length} คน จาก ${Object.keys(departmentGroups).length} แผนก</p>
                    </div>
                `;
                
                Object.entries(departmentGroups).forEach(([department, employees]) => {
                    reportHTML += `
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <h4 class="font-semibold text-gray-800 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-blue-600">business</span>
                                    แผนก ${department}
                                    <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">${employees.length} คน</span>
                                </h4>
                            </div>
                            <div class="p-4">
                                <div class="space-y-3">
                    `;
                    
                    employees.forEach(emp => {
                        const statusColor = getStatusColor(emp.attendance.status);
                        reportHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <img src="${emp.photoUrl || 'https://placehold.co/40x40/EFEFEF/AAAAAA?text=No+Img'}" 
                                         alt="${emp.fullName}" 
                                         class="w-10 h-10 rounded-full object-cover bg-gray-200" 
                                         onerror="this.src='https://placehold.co/40x40/EFEFEF/AAAAAA?text=Error'">
                                    <div>
                                        <p class="font-medium text-gray-800">${emp.fullName}</p>
                                        <p class="text-sm text-gray-500">${emp.employeeId}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                        ${emp.attendance.status}
                                    </span>
                                    ${emp.attendance.reason ? `<p class="text-xs text-gray-500 mt-1">${emp.attendance.reason}</p>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    reportHTML += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('report-content').innerHTML = reportHTML;
            };
            
            const getStatusColor = (status) => {
                const colors = {
                    'ลาป่วย': 'bg-blue-100 text-blue-800',
                    'ลากิจ': 'bg-yellow-100 text-yellow-800',
                    'ลาพักร้อน': 'bg-green-100 text-green-800',
                    'ลงบวช': 'bg-purple-100 text-purple-800',
                    'ลาแต่งงาน': 'bg-pink-100 text-pink-800',
                    'ขาดงาน': 'bg-red-100 text-red-800',
                    'ลาออก': 'bg-gray-100 text-gray-800'
                };
                return colors[status] || 'bg-gray-100 text-gray-800';
            };
            
            const formatThaiDate = (dateStr) => {
                const date = new Date(dateStr);
                const thaiMonths = [
                    'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                    'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                ];
                return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
            };
            
            // --- OT Plan Functions ---
            const initializeOtPlanPage = () => {
                const today = new Date().toISOString().split('T')[0];
                otDatePicker.value = today;
                fetchEmployeesForOtPlan(today);
            };

            const fetchEmployeesForOtPlan = async (date) => {
                 otPlanTabs.innerHTML = `<p class="p-4 text-gray-500">กำลังโหลด...</p>`;
                 otPlanTabContent.innerHTML = '';
                try {
                    const [empResult, planResult, attendanceResult] = await Promise.all([
                        getCachedEmployees(),
                        getCachedOtPlan(date),
                        getCachedAttendance(date)
                    ]);

                    if (empResult.status === 'success') {
                        const existingPlan = planResult.status === 'success' ? planResult.data : [];
                        const existingAttendance = attendanceResult.status === 'success' ? attendanceResult.data : [];
                        renderOtPlanList(empResult.data, existingPlan, existingAttendance);
                        
                        if (empResult.fromCache || planResult.fromCache || attendanceResult.fromCache) {
                            console.log('OT Plan data loaded from cache');
                        }
                    } else {
                        showMessage(empResult.message, true);
                        otPlanTabs.innerHTML = `<p class="p-4 text-red-500">ไม่สามารถโหลดข้อมูลพนักงานได้</p>`;
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', true);
                    otPlanTabs.innerHTML = `<p class="p-4 text-red-500">เกิดข้อผิดพลาดในการเชื่อมต่อ</p>`;
                }
            };

            const renderOtPlanList = (employees, existingPlan, existingAttendance) => {
                otPlanTabs.innerHTML = '';
                otPlanTabContent.innerHTML = '';
                 if (!employees || employees.length === 0) {
                    otPlanTabs.innerHTML = `<p class="p-4 text-gray-500">ยังไม่มีข้อมูลพนักงาน</p>`;
                    return;
                }

                const planMap = existingPlan.reduce((acc, plan) => { acc[plan.employeeId] = plan; return acc; }, {});
                const attendanceMap = existingAttendance.reduce((acc, record) => { acc[record.employeeId] = record; return acc; }, {});

                const groupedByDept = employees.reduce((acc, emp) => {
                    const dept = emp.department || 'ไม่ระบุส่วนงาน';
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(emp);
                    return acc;
                }, {});
                
                let isFirstTab = true;

                for (const dept in groupedByDept) {
                    const tabButton = document.createElement('button');
                    tabButton.className = `tab-btn px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap`;
                    tabButton.textContent = dept;
                    tabButton.dataset.department = dept;
                    if (isFirstTab) tabButton.classList.add('active');
                    otPlanTabs.appendChild(tabButton);
                    
                    const deptContainer = document.createElement('div');
                    deptContainer.className = 'tab-pane';
                    if (!isFirstTab) deptContainer.classList.add('hidden');
                    deptContainer.dataset.departmentContent = dept;

                    const deptHeader = document.createElement('div');
                    deptHeader.className = 'flex justify-between items-center p-4 bg-gray-100 rounded-t-lg';
                    deptHeader.innerHTML = `
                        <div class="flex flex-col">
                            <h3 class="text-md font-bold text-gray-800">${dept}</h3>
                            <div class="dept-summary text-sm text-gray-600 mt-1">
                                <span class="total-employees">พนักงาน: ${groupedByDept[dept].length} คน</span> | 
                                <span class="total-ot-employees">OT: 0 คน</span> | 
                                <span class="total-ot-hours">รวม: 0.0 ชั่วโมง</span>
                            </div>
                        </div>
                         <div class="flex items-center gap-2">
                            <button type="button" class="dept-select-all-ot-btn bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600 transition-colors" data-department="${dept}">
                                เลือกทั้งหมด
                            </button>
                            <button type="button" class="dept-reset-ot-btn bg-gray-500 text-white px-3 py-1 rounded text-xs hover:bg-gray-600 transition-colors" data-department="${dept}">
                                รีเซต
                            </button>
                             <button type="button" class="dept-save-ot-btn bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition-colors" data-department="${dept}">
                                บันทึก
                            </button>
                        </div>
                    `;
                    deptContainer.appendChild(deptHeader);
                    
                    const list = document.createElement('div');
                    list.className = 'divide-y bg-white rounded-b-lg shadow-sm';

                    groupedByDept[dept].forEach(emp => {
                        const plan = planMap[emp.employeeId] || {};
                        const attendanceRecord = attendanceMap[emp.employeeId] || { status: 'มาทำงาน' };
                        const isNotWorking = attendanceRecord.status !== 'มาทำงาน' && attendanceRecord.status !== 'สาย/Meeting';
                        
                        const card = document.createElement('div');
                        card.className = 'p-4';
                        card.dataset.employeeId = emp.employeeId;
                        card.dataset.attendanceStatus = attendanceRecord.status;


                        const isOt = !!plan.startTime && !isNotWorking;

                        card.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <input type="checkbox" class="ot-checkbox mt-1 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${isOt ? 'checked' : ''} ${isNotWorking ? 'disabled' : ''}>
                                <img src="${emp.photoUrl || 'https://placehold.co/48x48/EFEFEF/AAAAAA?text=No+Img'}" alt="${emp.fullName}" class="w-12 h-12 rounded-full object-cover bg-gray-200" onerror="this.src='https://placehold.co/48x48/EFEFEF/AAAAAA?text=Error'">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">${emp.fullName}</p>
                                    <p class="text-sm text-gray-500">${emp.employeeId}</p>
                                    ${isNotWorking ? `<p class="text-xs text-red-500 font-bold mt-1">${attendanceRecord.status}</p>` : ''}
                                </div>
                            </div>
                            <div class="employee-duty" data-duty="${emp.duty || ''}" style="display: none;"></div>
                            <div class="ot-details pl-16 mt-2 space-y-2 ${isOt ? '' : 'hidden'}">
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500">เวลาเริ่ม</label>
                                        <input type="time" class="ot-start-time w-full border border-gray-300 rounded p-1 text-sm" value="${plan.startTime || '17:30'}">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">เวลาสิ้นสุด</label>
                                        <input type="time" class="ot-end-time w-full border border-gray-300 rounded p-1 text-sm" value="${plan.endTime || '20:30'}">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">ชั่วโมง OT</label>
                                        <div class="ot-hours-display bg-blue-50 border border-blue-200 rounded p-1 text-sm text-center font-bold text-blue-700">0.0</div>
                                    </div>
                                </div>
                                 <div class="flex gap-2">
                                    <button type="button" class="ot-off-btn bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors">ออกโอที</button>
                                    <button type="button" class="ot-saturday-off-btn bg-yellow-500 text-white px-3 py-1 rounded text-xs hover:bg-yellow-600 transition-colors">หยุดวันเสาร์</button>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">หมายเหตุ / งาน</label>
                                    <input type="text" class="ot-notes w-full border border-gray-300 rounded p-1 text-sm" placeholder="ระบุงานที่ทำ" value="${plan.notes || ''}">
                                </div>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                     deptContainer.appendChild(list);
                     otPlanTabContent.appendChild(deptContainer);
                     
                     // Calculate initial OT hours for this department
                     setTimeout(() => {
                         list.querySelectorAll('[data-employee-id]').forEach(card => {
                             calculateOtHours(card);
                         });
                         updateDepartmentSummary(deptContainer);
                     }, 100);
                     
                     isFirstTab = false;
                }

                 // Add event listeners for tabs
                otPlanTabs.addEventListener('click', (e) => {
                     const tabButton = e.target.closest('.tab-btn');
                    if(tabButton){
                        otPlanTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabButton.classList.add('active');
                        
                        otPlanTabContent.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                        otPlanTabContent.querySelector(`[data-department-content="${tabButton.dataset.department}"]`).classList.remove('hidden');
                    }
                });

                // Add event listeners using event delegation for better performance
                otPlanTabContent.addEventListener('change', (e) => {
                     if(e.target.classList.contains('ot-checkbox')){
                        const card = e.target.closest('[data-employee-id]');
                        const details = card.querySelector('.ot-details');
                        if (e.target.checked) {
                            details.classList.remove('hidden');
                            // แสดงหน้าที่ในช่องหมายเหตุถ้าทำ OT ปกติ
                            const dutyElement = card.querySelector('.employee-duty');
                            const notesInput = card.querySelector('.ot-notes');
                            if (dutyElement && notesInput && dutyElement.dataset.duty && !notesInput.value) {
                                notesInput.value = dutyElement.dataset.duty;
                            }
                            calculateOtHours(card);
                        } else {
                            details.classList.add('hidden');
                        }
                        updateDepartmentSummary(card.closest('.tab-pane'));
                     }
                     
                     if(e.target.classList.contains('ot-start-time') || e.target.classList.contains('ot-end-time')){
                        const card = e.target.closest('[data-employee-id]');
                        calculateOtHours(card);
                        updateDepartmentSummary(card.closest('.tab-pane'));
                     }
                });
                
                otPlanTabContent.addEventListener('click', (e) => {
                    const button = e.target.closest('.ot-off-btn, .ot-saturday-off-btn, .dept-reset-ot-btn, .dept-select-all-ot-btn, .dept-save-ot-btn');
                    if(!button) return;

                    if(button.classList.contains('ot-off-btn')){
                        const card = button.closest('[data-employee-id]');
                        const startTimeInput = card.querySelector('.ot-start-time');
                        const endTimeInput = card.querySelector('.ot-end-time');
                        startTimeInput.value = '17:00';
                        endTimeInput.value = '17:00';
                        calculateOtHours(card);
                        updateDepartmentSummary(card.closest('.tab-pane'));
                    }

                    if(button.classList.contains('ot-saturday-off-btn')){
                        const card = button.closest('[data-employee-id]');
                        const startTimeInput = card.querySelector('.ot-start-time');
                        const endTimeInput = card.querySelector('.ot-end-time');
                        const notesInput = card.querySelector('.ot-notes');
                        startTimeInput.value = '00:00';
                        endTimeInput.value = '00:00';
                        notesInput.value = 'หยุดวันเสาร์';
                        calculateOtHours(card);
                        updateDepartmentSummary(card.closest('.tab-pane'));
                    }
                    
                    if(button.classList.contains('dept-select-all-ot-btn')){
                        const deptContainer = button.closest('.tab-pane');
                        deptContainer.querySelectorAll('.ot-checkbox').forEach(checkbox => {
                             if (!checkbox.disabled && !checkbox.checked) {
                                checkbox.checked = true;
                                const changeEvent = new Event('change', { bubbles: true });
                                checkbox.dispatchEvent(changeEvent);
                            }
                        });
                        updateDepartmentSummary(deptContainer);
                        showMessage(`เลือกพนักงานทั้งหมดในส่วนงาน ${button.dataset.department} เรียบร้อยแล้ว`);
                    }

                    if(button.classList.contains('dept-reset-ot-btn')){
                         const deptContainer = button.closest('.tab-pane');
                         deptContainer.querySelectorAll('[data-employee-id]').forEach(card => {
                            const checkbox = card.querySelector('.ot-checkbox');
                             if (checkbox && checkbox.checked) {
                                checkbox.checked = false;
                                const changeEvent = new Event('change', { bubbles: true });
                                checkbox.dispatchEvent(changeEvent);
                            }
                         });
                         updateDepartmentSummary(deptContainer);
                         showMessage(`รีเซตข้อมูล ${button.dataset.department} เรียบร้อยแล้ว`);
                    }
                     if (button.classList.contains('dept-save-ot-btn')) {
                        const department = button.dataset.department;
                        handleSaveOtPlan(department, button);
                    }
                });
            };

            // Function to calculate OT hours for individual employee
            const calculateOtHours = (card) => {
                const checkbox = card.querySelector('.ot-checkbox');
                const startTimeInput = card.querySelector('.ot-start-time');
                const endTimeInput = card.querySelector('.ot-end-time');
                const hoursDisplay = card.querySelector('.ot-hours-display');
                
                if (!checkbox || !checkbox.checked || checkbox.disabled) {
                    hoursDisplay.textContent = '0.0';
                    return 0;
                }
                
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;
                
                if (!startTime || !endTime) {
                    hoursDisplay.textContent = '0.0';
                    return 0;
                }
                
                // Special case: Saturday off (00:00 to 00:00) should be 0 hours
                if (startTime === '00:00' && endTime === '00:00') {
                    hoursDisplay.textContent = '0.0';
                    return 0;
                }
                
                // Special case: OT off (17:00 to 17:00) should be 0 hours
                if (startTime === '17:00' && endTime === '17:00') {
                    hoursDisplay.textContent = '0.0';
                    return 0;
                }
                
                // Convert time to minutes for calculation
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                let startMinutes = startHour * 60 + startMin;
                let endMinutes = endHour * 60 + endMin;
                
                // Handle overnight OT (end time next day)
                if (endMinutes <= startMinutes) {
                    endMinutes += 24 * 60; // Add 24 hours
                }
                
                const totalMinutes = endMinutes - startMinutes;
                const hours = totalMinutes / 60;
                
                hoursDisplay.textContent = hours.toFixed(1);
                return hours;
            };
            
            // Function to update department summary
             const updateDepartmentSummary = (deptContainer) => {
                 const totalOtEmployeesSpan = deptContainer.querySelector('.total-ot-employees');
                 const totalOtHoursSpan = deptContainer.querySelector('.total-ot-hours');
                 
                 const employeeCards = deptContainer.querySelectorAll('[data-employee-id]');
                 const totalEmployees = employeeCards.length;
                 
                 let otEmployeeCount = 0;
                 let totalOtHours = 0;
                 
                 employeeCards.forEach(card => {
                     const checkbox = card.querySelector('.ot-checkbox');
                     if (checkbox && checkbox.checked && !checkbox.disabled) {
                         otEmployeeCount++;
                         const hours = calculateOtHours(card);
                         totalOtHours += hours;
                     }
                 });
                 
                 totalOtEmployeesSpan.textContent = `OT: ${otEmployeeCount} คน`;
                 totalOtHoursSpan.textContent = `รวม: ${totalOtHours.toFixed(1)} ชั่วโมง`;
                 
                 // Update overall summary
                 updateOverallSummary();
             };
             
             // Function to update overall summary
             const updateOverallSummary = () => {
                 const totalSummary = document.getElementById('ot-total-summary');
                 const totalAllEmployeesSpan = document.getElementById('total-all-employees');
                 const totalAllOtEmployeesSpan = document.getElementById('total-all-ot-employees');
                 const totalAllOtHoursSpan = document.getElementById('total-all-ot-hours');
                 
                 let allEmployeeCount = 0;
                 let allOtEmployeeCount = 0;
                 let allOtHours = 0;
                 
                 document.querySelectorAll('.tab-pane [data-employee-id]').forEach(card => {
                     allEmployeeCount++;
                     const checkbox = card.querySelector('.ot-checkbox');
                     if (checkbox && checkbox.checked && !checkbox.disabled) {
                         allOtEmployeeCount++;
                         const hoursDisplay = card.querySelector('.ot-hours-display');
                         const hours = parseFloat(hoursDisplay.textContent) || 0;
                         allOtHours += hours;
                     }
                 });
                 
                 totalAllEmployeesSpan.textContent = `พนักงานทั้งหมด: ${allEmployeeCount} คน`;
                 totalAllOtEmployeesSpan.textContent = `OT: ${allOtEmployeeCount} คน`;
                 totalAllOtHoursSpan.textContent = `รวม: ${allOtHours.toFixed(1)} ชั่วโมง`;
                 
                 // Show summary if there are employees
                 if (allEmployeeCount > 0) {
                     totalSummary.classList.remove('hidden');
                 } else {
                     totalSummary.classList.add('hidden');
                 }
             };

            const handleSaveOtPlan = async (departmentToSave, button) => {
                const date = otDatePicker.value;
                if (!date) { showMessage('กรุณาเลือกวันที่', true); return; }

                const plans = [];
                const deptContainer = document.querySelector(`[data-department-content="${departmentToSave}"]`);
                if(deptContainer){
                    deptContainer.querySelectorAll('[data-employee-id]').forEach(card => {
                        const checkbox = card.querySelector('.ot-checkbox');
                        
                        // Always save a record for every employee in the department
                        const employeeId = card.dataset.employeeId;
                        let startTime = '', endTime = '', notes = '';

                        if (checkbox && checkbox.checked) { 
                            startTime = card.querySelector('.ot-start-time').value;
                            endTime = card.querySelector('.ot-end-time').value;
                            notes = card.querySelector('.ot-notes').value;
                        } else if (checkbox && checkbox.disabled) {
                            notes = card.dataset.attendanceStatus || 'ลา';
                        }
                        // For employees not on leave and not selected for OT, startTime, endTime, and notes will be blank
                        
                        plans.push({ employeeId, startTime, endTime, notes });
                    });
                }
                
                button.disabled = true;
                button.textContent = 'กำลังบันทึก...';
                
                try {
                     const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'saveOtPlan',
                            data: { date, plans, department: departmentToSave }
                        })
                    });
                    const result = await response.json();
                    if(result.status === 'success') {
                        showMessage(`บันทึกแผน OT ส่วนงาน ${departmentToSave} เรียบร้อยแล้ว`);
                    } else {
                        showMessage(result.message, true);
                    }

                } catch(error) {
                    showMessage('เกิดข้อผิดพลาดในการบันทึก', true);
                } finally {
                    button.disabled = false;
                    button.textContent = 'บันทึก';
                }
            };


            otDatePicker.addEventListener('change', () => fetchEmployeesForOtPlan(otDatePicker.value));


            const toggleView = (show) => {
                currentPage = show; // Update current page
                Object.values(containers).forEach(c => c.classList.add('hidden'));
                const pageMap = {
                    'login': ['auth', 'login'], 'register': ['auth', 'register'],
                    'home': ['home'], 'employee-list': ['employeeList'],
                    'add-employee': ['addEmployee'],
                    'ot-plan': ['otPlan'], 'attendance': ['attendance'],
                    'calendar': ['calendar'], 'reports': ['reports'], 
                    'attendance-report': ['attendanceReport'],
                    'ot-report': ['otReport'],
                    'settings': ['settings'], 'help': ['help'],
                    'shift-management': ['shiftManagement'],
                    'shift-schedule': ['shiftSchedule']
                };
                if (pageMap[show]) {
                    pageMap[show].forEach(key => {
                        if (containers[key]) {
                            containers[key].classList.remove('hidden');
                        }
                    });
                }
                // Highlight active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    const linkPage = link.dataset.page;
                    const isMoreMenuButton = link.id === 'more-menu-btn';
                    const moreMenuPages = ['ot-plan', 'calendar', 'reports', 'settings', 'help', 'shift-management', 'shift-schedule'];

                    if ((isMoreMenuButton && moreMenuPages.includes(show)) || linkPage === show) {
                        link.classList.remove('text-gray-500', 'hover:text-[var(--primary-600)]');
                        link.classList.add('text-[var(--primary-600)]', 'font-semibold');
                    } else {
                         link.classList.add('text-gray-500', 'hover:text-[var(--primary-600)]');
                        link.classList.remove('text-[var(--primary-600)]', 'font-semibold');
                    }
                });
                
                // Lazy loading - only load data if page hasn't been initialized
                if (show === 'employee-list' && !pageInitialized['employee-list']) { 
                    fetchAndDisplayEmployees(); 
                    pageInitialized['employee-list'] = true;
                }
                if (show === 'ot-plan' && !pageInitialized['ot-plan']) { 
                    initializeOtPlanPage(); 
                    pageInitialized['ot-plan'] = true;
                }
                if (show === 'ot-report' && !pageInitialized['ot-report']) { 
                    initializeOtReportPage(); 
                    pageInitialized['ot-report'] = true;
                }
                if (show === 'attendance' && !pageInitialized['attendance']) { 
                    initializeAttendancePage(); 
                    pageInitialized['attendance'] = true;
                }
                if (show === 'calendar' && !pageInitialized['calendar']) { 
                    initializeCalendarPage(); 
                    pageInitialized['calendar'] = true;
                }
                if (show === 'shift-management' && !pageInitialized['shift-management']) { 
                    loadShiftEmployees(); 
                    pageInitialized['shift-management'] = true;
                }
            };
            
            // Make toggleView globally accessible
            window.toggleView = toggleView;
            
            const initializeCalendarPage = async () => {
                document.getElementById('calendar-grid').innerHTML = '<p class="col-span-7 text-center p-4">กำลังโหลดข้อมูลการลา...</p>';
                
                try {
                    const response = await fetch(`${GAS_URL}?action=getCalendarLeaveData`);
                    const result = await response.json();
                    if (result.status === 'success') {
                        calendarLeaveData = result.data;
                    } else {
                        showMessage(result.message, true);
                        calendarLeaveData = {};
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการดึงข้อมูลปฏิทิน', true);
                    calendarLeaveData = {};
                }
                
                renderCalendar();
                setupCalendarEventListeners();
            };
            
            let currentDate = new Date();
            
            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                                  'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                document.getElementById('current-month-year').textContent = `${monthNames[month]} ${year + 543}`;
                
                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '';
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'h-12';
                    calendarGrid.appendChild(emptyCell);
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasLeave = calendarLeaveData[dateStr];
                    
                    dayCell.className = `h-12 flex flex-col items-center justify-center text-sm cursor-pointer rounded-lg transition-colors ${
                        hasLeave ? 'bg-red-100 text-red-800 hover:bg-red-200 border border-red-300' : 'hover:bg-gray-100'
                    }`;
                    
                    dayCell.innerHTML = `
                        <span class="font-medium">${day}</span>
                        ${hasLeave ? `<span class="text-xs text-red-600 font-semibold">${hasLeave.length} ลา</span>` : ''}
                    `;
                    
                    if (hasLeave) {
                        dayCell.title = `มีพนักงาน ${hasLeave.length} คนลางาน - คลิกเพื่อดูรายละเอียด`;
                        dayCell.addEventListener('click', () => showLeaveDetails(dateStr));
                    }
                    
                    calendarGrid.appendChild(dayCell);
                }
            };
            
            const setupCalendarEventListeners = () => {
                document.getElementById('prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                
                document.getElementById('next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
                
                document.getElementById('close-leave-details').addEventListener('click', hideLeaveDetails);
            };
            
            const showLeaveDetails = (dateStr) => {
                const leaveData = calendarLeaveData[dateStr];
                const panel = document.getElementById('leave-details-panel');
                const content = document.getElementById('leave-details-content');
                const selectedDateEl = document.getElementById('selected-date');
                
                const date = new Date(dateStr);
                 const thaiDate = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: 'UTC' 
                });
                selectedDateEl.textContent = thaiDate;
                
                if (leaveData && leaveData.length > 0) {
                     content.innerHTML = `
                        <div class="space-y-3">
                    ` + leaveData.map(leave => `
                        <div class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">
                            <div class="flex items-center justify-between mb-1">
                                <h4 class="font-medium text-gray-800">${leave.employeeName}</h4>
                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">${leave.leaveType}</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">รหัส: ${leave.employeeId || 'ไม่ระบุ'}</p>
                            <p class="text-sm text-gray-600"><strong>เหตุผล:</strong> ${leave.reason || 'ไม่ได้ระบุ'}</p>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = `<p class="text-center text-gray-500 py-4">ไม่มีพนักงานลางานในวันนี้</p>`;
                }
                
                panel.classList.remove('hidden');
            };
            
            const hideLeaveDetails = () => {
                document.getElementById('leave-details-panel').classList.add('hidden');
            };
            
            // More Menu Functions
            const showMoreMenu = () => {
                moreMenuModal.classList.remove('hidden');
                moreMenuModal.classList.add('flex');
                setTimeout(() => {
                    moreMenuModal.classList.add('opacity-100');
                    moreMenuContent.classList.add('translate-y-0', 'sm:scale-100');
                    moreMenuContent.classList.remove('translate-y-full', 'sm:scale-95');
                }, 10);
            };
            
            const hideMoreMenu = (navigateTo = null) => {
                moreMenuModal.classList.remove('opacity-100');
                moreMenuContent.classList.remove('translate-y-0', 'sm:scale-100');
                moreMenuContent.classList.add('translate-y-full', 'sm:scale-95');
                setTimeout(() => {
                    moreMenuModal.classList.add('hidden');
                    moreMenuModal.classList.remove('flex');
                    if (navigateTo) {
                        toggleView(navigateTo);
                    } else {
                        // If just closing, reset the nav link to the current page
                        toggleView(currentPage);
                    }
                }, 300);
            };
            
            // Shift Management Functions
            // *** SIMPLIFIED: Improved logic for fetching and parsing employee data ***
            const loadShiftEmployees = async () => {
                try {
                    const result = await getCachedEmployees();
                    
                    if (result.status === 'success' && Array.isArray(result.data)) {
                        shiftEmployeeData = result.data;
                        
                        if (result.fromCache) {
                            console.log('Shift employees data loaded from cache');
                        }
                    } else {
                         throw new Error('Invalid data format from API.');
                    }
                } catch (error) {
                    console.error('Error loading employees for shift:', error);
                    showMessage('ไม่สามารถโหลดข้อมูลพนักงานได้', true);
                    shiftEmployeeData = []; // Clear data on error
                }

                // Group employees by department
                shiftEmployeesByDepartment = {};
                availableDepartments = [];
                
                shiftEmployeeData.forEach(employee => {
                    const dept = employee.department || 'ไม่ระบุส่วนงาน';
                    if (!shiftEmployeesByDepartment[dept]) {
                        shiftEmployeesByDepartment[dept] = [];
                        availableDepartments.push(dept);
                    }
                    shiftEmployeesByDepartment[dept].push(employee);
                });
                
                availableDepartments.sort();
                createDepartmentTabs();
                renderShiftEmployeeList();
            };
            
            const renderShiftEmployeeList = () => {
                if (!shiftEmployeeList) return;
                
                shiftEmployeeList.innerHTML = '';
                
                let employeesToShow = (selectedDepartment === 'all') ? shiftEmployeeData : (shiftEmployeesByDepartment[selectedDepartment] || []);
                
                if (employeesToShow.length === 0) {
                    shiftEmployeeList.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีข้อมูลพนักงานในส่วนงานนี้</p>';
                    return;
                }
                
                const listFragment = document.createDocumentFragment();
                employeesToShow.forEach(employee => {
                    const isAssigned = currentShiftAssignments[employee.employeeId] || false;
                    const employeeCard = document.createElement('div');
                    employeeCard.className = `p-3 mb-2 border rounded-lg transition-colors flex items-center justify-between ${
                        isAssigned ? 'bg-blue-50 border-blue-300' : 'bg-white border-gray-200'
                    }`;
                    
                    employeeCard.innerHTML = `
                        <div class="flex items-center space-x-3">
                             <img src="${employee.photoUrl || 'https://placehold.co/40x40/EFEFEF/AAAAAA?text=?'}" alt="${employee.fullName}" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <p class="font-medium text-gray-800">${employee.fullName}</p>
                                <p class="text-sm text-gray-500">${employee.employeeId}</p>
                            </div>
                        </div>
                        <input type="checkbox" 
                                data-employee-id="${employee.employeeId}"
                                class="shift-checkbox w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                ${isAssigned ? 'checked' : ''}>
                    `;
                    listFragment.appendChild(employeeCard);
                });
                shiftEmployeeList.appendChild(listFragment);
                
                // Update selected count display after rendering
                updateSelectedCount();
            };
            
            // Function to update selected employee count display
            const updateSelectedCount = () => {
                const selectedCount = Object.keys(currentShiftAssignments).length;
                const countElement = document.getElementById('selected-count');
                const countNumberElement = document.getElementById('selected-count-number');
                
                if (selectedCount > 0) {
                    countElement.classList.remove('hidden');
                    countNumberElement.textContent = selectedCount;
                } else {
                    countElement.classList.add('hidden');
                }
            };

            shiftEmployeeList.addEventListener('change', (e) => {
                if (e.target.classList.contains('shift-checkbox')) {
                    const employeeId = e.target.dataset.employeeId;
                    if (e.target.checked) {
                        currentShiftAssignments[employeeId] = true;
                    } else {
                        delete currentShiftAssignments[employeeId];
                    }
                    // Re-rendering is simple but you could also just toggle the class on the parent for performance
                    e.target.closest('.p-3').classList.toggle('bg-blue-50');
                    e.target.closest('.p-3').classList.toggle('border-blue-300');
                    
                    // Update selected count display
                    updateSelectedCount();
                }
            });


            // *** UPDATED: Function to save weekly shift assignments ***
            const saveShiftAssignment = async () => {
                const button = document.getElementById('save-shift-btn');
                if (!selectedShiftType || !selectedWeekStart || !selectedWeekEnd) {
                    showMessage('กรุณาเลือกประเภทกะและสัปดาห์', true);
                    return;
                }
                
                const assignedEmployeeIds = Object.keys(currentShiftAssignments);
                
                if (assignedEmployeeIds.length === 0) {
                    showMessage('กรุณาเลือกพนักงานอย่างน้อย 1 คน', true);
                    return;
                }
                
                button.disabled = true;
                button.innerHTML = `<span class="material-symbols-outlined mr-1 text-base animate-spin">autorenew</span> กำลังบันทึก...`;

                try {
                    console.log('Debug values:');
                    console.log('selectedWeekStart:', selectedWeekStart);
                    console.log('selectedShiftType:', selectedShiftType);
                    console.log('assignedEmployeeIds:', assignedEmployeeIds);
                    console.log('selectedShiftTime:', selectedShiftTime);

                    const shiftData = {
                        date: selectedWeekStart,
                        shiftType: selectedShiftType,
                        employeeIds: assignedEmployeeIds, // Support multiple employees per week
                        shiftTime: selectedShiftTime
                    };
                    
                    console.log('Sending shift data:', shiftData);
                    
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveShiftAssignment', shiftData })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showMessage(`บันทึกการจัดเข้ากะเรียบร้อยแล้ว (${assignedEmployeeIds.length} คน)`);
                    } else {
                        showMessage(result.message || 'เกิดข้อผิดพลาดในการบันทึก', true);
                    }
                } catch (error) {
                    console.error('Error saving shift assignment:', error);
                    showMessage('เกิดข้อผิดพลาดในการบันทึก', true);
                } finally {
                    button.disabled = false;
                     button.innerHTML = `<span class="material-symbols-outlined mr-1 text-base">save</span> บันทึก`;
                }
            };
            
            
            const handleShiftTypeChange = (shiftType, shiftTime) => {
                selectedShiftType = shiftType;
                selectedShiftTime = shiftTime;
                
                document.querySelectorAll('.shift-type-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500', 'ring-purple-500'));
                
                if (shiftType === 'กะเช้า') {
                    morningShiftBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                } else if (shiftType === 'กะดึก') {
                    nightShiftBtn.classList.add('ring-2', 'ring-offset-2', 'ring-purple-500');
                }
                
                updateShiftInfo();
                
                if (selectedShiftType && selectedWeekStart) {
                    loadShiftAssignments();
                }
            };
            
            const updateShiftInfo = () => {
                const shiftInfoElement = document.getElementById('shift-info');
                const saveBtn = document.getElementById('save-shift-btn');
                const autoAssignBtn = document.getElementById('auto-assign-btn');
                
                if (selectedShiftType && selectedWeekStart && selectedWeekEnd) {
                    const startDate = new Date(selectedWeekStart).toLocaleDateString('th-TH');
                    const endDate = new Date(selectedWeekEnd).toLocaleDateString('th-TH');
                    shiftInfoElement.textContent = `กำลังจัดกะ: ${selectedShiftType} สัปดาห์ ${startDate} - ${endDate} (1 สัปดาห์ต่อ 1 คน)`;
                    if (saveBtn) saveBtn.disabled = false;
                    if (autoAssignBtn) autoAssignBtn.disabled = false;
                } else {
                    shiftInfoElement.textContent = 'เลือกประเภทกะและสัปดาห์เพื่อเริ่มกำหนดกะ (สามารถเลือกพนักงานหลายคนต่อสัปดาห์)';
                    if (saveBtn) saveBtn.disabled = true;
                    if (autoAssignBtn) autoAssignBtn.disabled = true;
                }
            };
            
            // ฟังก์ชันจัดกะอัตโนมัติสำหรับพนักงานที่เหลือ
            const handleAutoAssign = () => {
                if (!selectedShiftType || !selectedWeekStart || !selectedWeekEnd) {
                    showMessage('กรุณาเลือกประเภทกะและสัปดาห์ก่อน', true);
                    return;
                }
                
                // หาพนักงานที่แสดงอยู่ในปัจจุบัน (ตาม department ที่เลือก)
                let employeesToShow = (selectedDepartment === 'all') ? shiftEmployeeData : (shiftEmployeesByDepartment[selectedDepartment] || []);
                
                if (employeesToShow.length === 0) {
                    showMessage('ไม่มีพนักงานในส่วนงานนี้', true);
                    return;
                }
                
                // หาพนักงานที่ยังไม่ได้เลือก
                const unassignedEmployees = employeesToShow.filter(employee => !currentShiftAssignments[employee.employeeId]);
                
                if (unassignedEmployees.length === 0) {
                    showMessage('พนักงานทุกคนได้รับการจัดกะแล้ว', true);
                    return;
                }
                
                // กำหนดกะตรงข้าม
                const oppositeShiftType = selectedShiftType === 'กะเช้า' ? 'กะดึก' : 'กะเช้า';
                const oppositeShiftTime = selectedShiftType === 'กะเช้า' ? '20:00 - 08:00' : '08:00 - 17:00';
                
                // แสดง confirmation dialog
                const confirmMessage = `จะจัดพนักงานที่เหลือ ${unassignedEmployees.length} คน เข้า${oppositeShiftType} โดยอัตโนมัติ\n\nต้องการดำเนินการต่อหรือไม่?`;
                
                if (confirm(confirmMessage)) {
                    // เพิ่มพนักงานที่เหลือเข้าในกะตรงข้าม
                    unassignedEmployees.forEach(employee => {
                        currentShiftAssignments[employee.employeeId] = true;
                    });
                    
                    // อัปเดตการแสดงผล
                    renderShiftEmployeeList();
                    
                    // แสดงข้อความยืนยัน
                    showMessage(`จัดกะอัตโนมัติเรียบร้อย: ${unassignedEmployees.length} คน เข้า${oppositeShiftType}`);
                    
                    // บันทึกข้อมูลกะตรงข้ามโดยอัตโนมัติ
                    saveOppositeShiftAssignment(unassignedEmployees, oppositeShiftType, oppositeShiftTime);
                }
            };
            
            // ฟังก์ชันบันทึกกะตรงข้ามโดยอัตโนมัติ
            const saveOppositeShiftAssignment = async (employees, shiftType, shiftTime) => {
                try {
                    const employeeIds = employees.map(emp => emp.employeeId);
                    
                    const shiftData = {
                        date: selectedWeekStart,
                        shiftType: shiftType,
                        employeeIds: employeeIds,
                        shiftTime: shiftTime
                    };
                    
                    console.log('Auto-saving opposite shift data:', shiftData);
                    
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveShiftAssignment', shiftData })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log(`Auto-saved ${employeeIds.length} employees to ${shiftType}`);
                    } else {
                        console.error('Error auto-saving opposite shift:', result.message);
                        showMessage(`เกิดข้อผิดพลาดในการบันทึกกะอัตโนมัติ: ${result.message}`, true);
                    }
                } catch (error) {
                    console.error('Error auto-saving opposite shift assignment:', error);
                    showMessage('เกิดข้อผิดพลาดในการบันทึกกะอัตโนมัติ', true);
                }
            };

            const handleWeekChange = () => {
                if (!weekStartPicker.value) {
                    weekDisplay.classList.add('hidden');
                    selectedWeekStart = null;
                    selectedWeekEnd = null;
                    updateShiftInfo();
                    return;
                }

                // Calculate week start (Monday) and end (Sunday)
                const selectedDate = new Date(weekStartPicker.value);
                const dayOfWeek = selectedDate.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // If Sunday (0), go back 6 days
                
                const weekStart = new Date(selectedDate);
                weekStart.setDate(selectedDate.getDate() + mondayOffset);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                selectedWeekStart = weekStart.toISOString().split('T')[0];
                selectedWeekEnd = weekEnd.toISOString().split('T')[0];
                
                // Display week range
                const startStr = weekStart.toLocaleDateString('th-TH');
                const endStr = weekEnd.toLocaleDateString('th-TH');
                weekRange.textContent = `${startStr} - ${endStr}`;
                weekDisplay.classList.remove('hidden');
                
                updateShiftInfo();
                if (selectedShiftType && selectedWeekStart) {
                    loadShiftAssignments();
                }
            };
            
            const loadShiftAssignments = async () => {
                if (!selectedShiftType || !selectedWeekStart) return;
                
                shiftEmployeeList.innerHTML = '<p class="text-gray-500 text-center py-4">กำลังโหลดข้อมูลกะ...</p>';

                try {
                    const response = await fetch(`${GAS_URL}?action=getShiftAssignments&date=${selectedWeekStart}&shiftType=${selectedShiftType}`);
                    const result = await response.json();
                    
                    currentShiftAssignments = {};
                    if (result.success && result.assignments) {
                        result.assignments.forEach(assignment => {
                            currentShiftAssignments[assignment.employeeId] = true;
                        });
                    }
                    renderShiftEmployeeList();
                } catch (error) {
                    console.error('Error loading shift assignments:', error);
                    showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูลกะ', true);
                    renderShiftEmployeeList(); // Render empty list on error
                }
            };

            // Weekly Shift Summary Report Functions
            const generateShiftSummaryReport = async () => {
                const generateBtn = document.getElementById('generate-shift-summary-btn');
                const exportBtn = document.getElementById('export-shift-summary-btn');
                const summaryContent = document.getElementById('shift-summary-content');
                
                generateBtn.disabled = true;
                generateBtn.innerHTML = `<span class="material-symbols-outlined text-base animate-spin">autorenew</span> กำลังสร้าง...`;
                
                try {
                    // Get last 4 weeks of data
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - 28); // 4 weeks back
                    
                    const response = await fetch(`${GAS_URL}?action=getShiftSummary&startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`);
                    const result = await response.json();
                    
                    if (result.success && result.summaryData) {
                        renderShiftSummaryTable(result.summaryData);
                        exportBtn.disabled = false;
                    } else {
                        throw new Error(result.message || 'ไม่สามารถโหลดข้อมูลสรุปได้');
                    }
                } catch (error) {
                    console.error('Error generating shift summary:', error);
                    summaryContent.innerHTML = `
                        <div class="text-center text-red-500 py-8">
                            <span class="material-symbols-outlined text-4xl mb-2 block">error</span>
                            <p>เกิดข้อผิดพลาดในการสร้างรายงาน</p>
                            <p class="text-sm mt-1">${error.message}</p>
                        </div>
                    `;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `<span class="material-symbols-outlined text-base">refresh</span> สร้างรายงาน`;
                }
            };
            
            const renderShiftSummaryTable = (summaryData) => {
                const summaryContent = document.getElementById('shift-summary-content');
                
                // Group data by week and department
                const weeklyData = {};
                const departments = ['Warehouse Manager', 'Assistant Warehouse Manager', 'A&I', 'MH', 'SSRM', 'COIL', 'FILM'];
                
                summaryData.forEach(record => {
                    const weekKey = record.weekStart;
                    if (!weeklyData[weekKey]) {
                        weeklyData[weekKey] = {
                            weekStart: record.weekStart,
                            weekEnd: record.weekEnd,
                            departments: {}
                        };
                    }
                    
                    if (!weeklyData[weekKey].departments[record.department]) {
                        weeklyData[weekKey].departments[record.department] = {
                            morning: { count: 0, employees: [] },
                            night: { count: 0, employees: [] },
                            total: 0
                        };
                    }
                    
                    if (record.shiftType === 'กะเช้า') {
                        weeklyData[weekKey].departments[record.department].morning = {
                            count: record.count,
                            employees: record.employees || []
                        };
                    } else if (record.shiftType === 'กะดึก') {
                        weeklyData[weekKey].departments[record.department].night = {
                            count: record.count,
                            employees: record.employees || []
                        };
                    }
                    weeklyData[weekKey].departments[record.department].total = 
                        weeklyData[weekKey].departments[record.department].morning.count + 
                        weeklyData[weekKey].departments[record.department].night.count;
                });
                
                const weeks = Object.keys(weeklyData).sort().reverse(); // Latest weeks first
                
                let tableHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 shadow-sm">
                        <div class="overflow-x-auto rounded-lg shadow-sm">
                            <table class="w-full border-collapse bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                                        <th class="px-4 py-4 text-left font-semibold text-sm border-r border-blue-500">
                                            <div class="flex items-center gap-2">
                                                <span class="material-symbols-outlined text-lg">business</span>
                                                แผนก
                                            </div>
                                        </th>
                `;
                
                // Add week headers
                weeks.forEach(weekKey => {
                    const week = weeklyData[weekKey];
                    const startDate = new Date(week.weekStart).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
                    const endDate = new Date(week.weekEnd).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
                    tableHTML += `
                        <th class="px-3 py-4 text-center font-semibold text-sm border-r border-blue-500" colspan="3">
                            <div class="flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined text-lg">calendar_month</span>
                                <span>${startDate} - ${endDate}</span>
                            </div>
                        </th>
                    `;
                });
                
                tableHTML += `</tr><tr class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
                    <th class="px-4 py-3 border-r border-blue-400"></th>
                `;
                
                // Add shift type sub-headers
                weeks.forEach(() => {
                    tableHTML += `
                        <th class="px-2 py-3 text-xs text-center border-r border-blue-400">
                            <div class="flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined text-sm">wb_sunny</span>
                                เช้า
                            </div>
                        </th>
                        <th class="px-2 py-3 text-xs text-center border-r border-blue-400">
                            <div class="flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined text-sm">nights_stay</span>
                                ดึก
                            </div>
                        </th>
                        <th class="px-2 py-3 text-xs text-center bg-yellow-500 border-r border-blue-400">
                            <div class="flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined text-sm">summarize</span>
                                รวม
                            </div>
                        </th>
                    `;
                });
                
                tableHTML += `</tr></thead><tbody>`;
                
                // Add department rows
                departments.forEach((dept, index) => {
                    const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    tableHTML += `<tr class="${rowBg} hover:bg-blue-50 transition-colors duration-200">
                        <td class="px-4 py-3 font-medium text-gray-800 border-r border-gray-200">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-gradient-to-r from-blue-400 to-indigo-400"></div>
                                ${dept}
                            </div>
                        </td>
                    `;
                    
                    weeks.forEach(weekKey => {
                        const deptData = weeklyData[weekKey].departments[dept] || { 
                            morning: { count: 0, employees: [] }, 
                            night: { count: 0, employees: [] }, 
                            total: 0 
                        };
                        
                        // Format employee names for morning shift
                        const morningNames = deptData.morning.employees.map(emp => emp.name).join(', ');
                        const morningTooltip = morningNames ? `title="${morningNames}"` : '';
                        
                        // Format employee names for night shift
                        const nightNames = deptData.night.employees.map(emp => emp.name).join(', ');
                        const nightTooltip = nightNames ? `title="${nightNames}"` : '';
                        
                        tableHTML += `
                            <td class="px-3 py-3 text-center text-sm border-r border-gray-200 cursor-help" ${morningTooltip}>
                                <div class="space-y-1">
                                    <div class="inline-flex items-center justify-center w-8 h-8 rounded-full ${deptData.morning.count > 0 ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-500'} font-bold text-sm">
                                        ${deptData.morning.count}
                                    </div>
                                    ${morningNames ? `<div class="text-xs text-gray-600 truncate max-w-20" title="${morningNames}">${morningNames}</div>` : ''}
                                </div>
                            </td>
                            <td class="px-3 py-3 text-center text-sm border-r border-gray-200 cursor-help" ${nightTooltip}>
                                <div class="space-y-1">
                                    <div class="inline-flex items-center justify-center w-8 h-8 rounded-full ${deptData.night.count > 0 ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'} font-bold text-sm">
                                        ${deptData.night.count}
                                    </div>
                                    ${nightNames ? `<div class="text-xs text-gray-600 truncate max-w-20" title="${nightNames}">${nightNames}</div>` : ''}
                                </div>
                            </td>
                            <td class="px-3 py-3 text-center border-r border-gray-200">
                                <div class="inline-flex items-center justify-center w-10 h-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white font-bold text-sm shadow-sm">
                                    ${deptData.total}
                                </div>
                            </td>
                        `;
                    });
                    
                    tableHTML += `</tr>`;
                });
                
                // Add total row
                tableHTML += `<tr class="bg-gradient-to-r from-green-100 to-emerald-100 border-t-2 border-green-300">
                    <td class="px-4 py-4 font-bold text-green-800 border-r border-green-300">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">calculate</span>
                            รวมทั้งหมด
                        </div>
                    </td>
                `;
                
                weeks.forEach(weekKey => {
                    let weekMorningTotal = 0;
                    let weekNightTotal = 0;
                    
                    Object.values(weeklyData[weekKey].departments).forEach(deptData => {
                        weekMorningTotal += deptData.morning.count;
                        weekNightTotal += deptData.night.count;
                    });
                    
                    tableHTML += `
                        <td class="px-3 py-4 text-center border-r border-green-300">
                            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-orange-500 text-white font-bold shadow-md">
                                ${weekMorningTotal}
                            </div>
                        </td>
                        <td class="px-3 py-4 text-center border-r border-green-300">
                            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-500 text-white font-bold shadow-md">
                                ${weekNightTotal}
                            </div>
                        </td>
                        <td class="px-3 py-4 text-center border-r border-green-300">
                            <div class="inline-flex items-center justify-center w-12 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold text-lg shadow-lg">
                                ${weekMorningTotal + weekNightTotal}
                            </div>
                        </td>
                    `;
                });
                
                tableHTML += `</tr></tbody></table>
                        </div>
                        
                        <!-- Legend and Notes -->
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-blue-600">info</span>
                                    คำอธิบาย
                                </h4>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full bg-orange-100 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-orange-600 text-sm">wb_sunny</span>
                                        </div>
                                        <span>กะเช้า (08:00-17:00)</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-indigo-600 text-sm">nights_stay</span>
                                        </div>
                                        <span>กะดึก (20:00-08:00)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-green-600">tips_and_updates</span>
                                    หมายเหตุ
                                </h4>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>• แสดงข้อมูล 4 สัปดาห์ล่าสุด</p>
                                    <p>• เลื่อนเมาส์ไปที่ตัวเลขเพื่อดูรายชื่อพนักงาน</p>
                                    <p>• ข้อมูลอัปเดตตามการจัดกะล่าสุด</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                summaryContent.innerHTML = tableHTML;
            };
            
            const exportShiftSummaryToExcel = () => {
                const table = document.querySelector('#shift-summary-content table');
                if (!table) {
                    showMessage('ไม่มีข้อมูลสำหรับส่งออก', true);
                    return;
                }
                
                // Create Excel-compatible HTML
                const excelHTML = `
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <title>รายงานสรุปกะรายสัปดาห์</title>
                    </head>
                    <body>
                        <h2>รายงานสรุปกะรายสัปดาห์</h2>
                        <p>วันที่สร้างรายงาน: ${new Date().toLocaleDateString('th-TH')}</p>
                        ${table.outerHTML}
                    </body>
                    </html>
                `;
                
                // Create and download file
                const blob = new Blob([excelHTML], { type: 'application/vnd.ms-excel' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `รายงานสรุปกะรายสัปดาห์_${new Date().toISOString().split('T')[0]}.xls`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('ส่งออกรายงานเรียบร้อยแล้ว');
            };

            // --- EVENT LISTENERS ---
            
            // Shift Management Event Listeners
            if (morningShiftBtn) {
                morningShiftBtn.addEventListener('click', () => handleShiftTypeChange('กะเช้า', '08:00 - 17:00'));
            }
            if (nightShiftBtn) {
                nightShiftBtn.addEventListener('click', () => handleShiftTypeChange('กะดึก', '20:00 - 08:00'));
            }
            if (weekStartPicker) {
                weekStartPicker.addEventListener('change', handleWeekChange);
            }
            if (saveShiftAssignmentBtn) {
                saveShiftAssignmentBtn.addEventListener('click', saveShiftAssignment);
            }
            
            // Auto Assign Button Event Listener
            const autoAssignBtn = document.getElementById('auto-assign-btn');
            if (autoAssignBtn) {
                autoAssignBtn.addEventListener('click', handleAutoAssign);
            }
            
            // Shift Summary Report Event Listeners
            const generateSummaryBtn = document.getElementById('generate-shift-summary-btn');
            const exportSummaryBtn = document.getElementById('export-shift-summary-btn');
            if (generateSummaryBtn) {
                generateSummaryBtn.addEventListener('click', generateShiftSummaryReport);
            }
            if (exportSummaryBtn) {
                exportSummaryBtn.addEventListener('click', exportShiftSummaryToExcel);
            }

            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleView('login'); });
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); toggleView('register'); });
            document.getElementById('add-employee-fab').addEventListener('click', () => { resetEmployeeForm(); toggleView('add-employee'); });
            document.getElementById('back-to-list-button').addEventListener('click', () => { resetEmployeeForm(); toggleView('employee-list'); });
            
            // Attendance Report Event Listeners
            document.getElementById('attendance-report-btn').addEventListener('click', () => {
                toggleView('attendance-report');
                initializeAttendanceReport();
            });
            document.getElementById('back-to-reports-btn').addEventListener('click', () => toggleView('reports'));
            
            // OT Report Event Listeners
            document.getElementById('ot-report-btn').addEventListener('click', () => {
                toggleView('ot-report');
                initializeOtReportPage();
            });
            document.getElementById('back-to-reports-from-ot-btn').addEventListener('click', () => toggleView('reports'));
            document.getElementById('load-report-btn').addEventListener('click', loadAttendanceReport);
            document.querySelectorAll('.nav-link:not(#more-menu-btn)').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); toggleView(link.dataset.page); }); });
            document.querySelectorAll('.logout-button').forEach(button => { button.addEventListener('click', () => { toggleView('login'); showMessage('คุณออกจากระบบเรียบร้อยแล้ว'); }); });
            
            // More Menu Event Listeners
            document.querySelectorAll('#more-menu-btn').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); showMoreMenu(); }));
            closeMoreMenuBtn.addEventListener('click', () => hideMoreMenu());
            moreMenuModal.addEventListener('click', (e) => { if (e.target === moreMenuModal) { hideMoreMenu(); } });
            document.querySelectorAll('.more-menu-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); hideMoreMenu(item.dataset.page); }));

            photoUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64String = event.target.result;
                        photoPreview.src = base64String;
                        photoBase64 = base64String.split(',')[1];
                    }
                    reader.readAsDataURL(file);
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button');
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                if (password !== confirmPassword) { showMessage('รหัสผ่านไม่ตรงกัน', true); return; }
                button.disabled = true; button.textContent = 'Registering...';
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'register',
                            username: document.getElementById('register-username').value.trim(),
                            password: password,
                            fullName: document.getElementById('register-fullname').value.trim(),
                            position: document.getElementById('register-position').value.trim(),
                            department: document.getElementById('register-department').value.trim()
                        })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('ลงทะเบียนสำเร็จ! กรุณาเข้าสู่ระบบ');
                        registerForm.reset();
                        toggleView('login');
                    } else { showMessage(result.message, true); }
                } catch (error) { showMessage('เกิดข้อผิดพลาดระหว่างการลงทะเบียน', true); } 
                finally { button.disabled = false; button.textContent = 'Register'; }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button');
                button.disabled = true; button.textContent = 'Logging in...';
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'login', username: document.getElementById('login-username').value.trim(), password: document.getElementById('login-password').value })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        // *** UPDATED: Correct login flow, go to home page ***
                        toggleView('home'); 
                        loginForm.reset();
                    } else { showMessage(result.message, true); }
                } catch (error) { showMessage('เกิดข้อผิดพลาดระหว่างการเข้าสู่ระบบ', true); } 
                finally { button.disabled = false; button.textContent = 'Login'; }
            });

            employeeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('save-employee-button');
                const employeeData = {
                    fullName: document.getElementById('full-name').value.trim(),
                    employeeId: document.getElementById('employee-id').value.trim(),
                    department: document.getElementById('department').value.trim(),
                    position: document.getElementById('position').value.trim(),
                    role: document.getElementById('role').value,
                    startDate: document.getElementById('start-date').value,
                    photo: photoBase64,
                    photoMimeType: photoUploadInput.files[0] ? photoUploadInput.files[0].type : null
                };

                if (!employeeData.fullName || !employeeData.employeeId) { showMessage('กรุณากรอกชื่อ-นามสกุล และรหัสพนักงาน', true); return; }
                
                const action = isEditMode ? 'updateEmployee' : 'addEmployee';
                if(isEditMode){
                    employeeData.originalEmployeeId = editingEmployeeId;
                }

                button.disabled = true; saveEmployeeButtonSpan.textContent = 'กำลังบันทึก...';
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: action, data: employeeData })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage(isEditMode ? 'อัปเดตข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลพนักงานเรียบร้อยแล้ว');
                        resetEmployeeForm();
                        toggleView('employee-list');
                    } else { showMessage(result.message, true); }
                } catch (error) { showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล', true); } 
                finally { button.disabled = false; saveEmployeeButtonSpan.textContent = isEditMode ? 'อัปเดต' : 'บันทึก'; }
            });

            // Initialize shift schedule page when accessed
            const originalToggleView = toggleView;
            window.toggleView = function(page) {
                originalToggleView(page);
                if (page === 'shift-schedule') {
                    initializeShiftSchedulePage();
                }
            };

            toggleView('login');
        });
        
        // Shift Schedule Functions
        const initializeShiftSchedulePage = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('schedule-date-picker').value = today;
        };
        
        const loadShiftSchedule = async (date) => {
            if (!date) {
                showMessage('กรุณาเลือกวันที่', true);
                return;
            }
            
            try {
                const response = await fetch(`${GAS_URL}?action=getShiftSchedule&date=${date}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    renderShiftScheduleTable(result.data, date);
                    document.getElementById('save-schedule-btn').disabled = false;
                } else {
                    showMessage(result.message || 'ไม่สามารถโหลดข้อมูลได้', true);
                }
            } catch (error) {
                showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูล', true);
            }
        };
        
        const renderShiftScheduleTable = (scheduleData, date) => {
            const container = document.getElementById('schedule-table-container');
            const info = document.getElementById('schedule-info');
            
            info.textContent = `ตารางกะวันที่ ${new Date(date).toLocaleDateString('th-TH')}`;
            
            if (!scheduleData || scheduleData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">ไม่มีข้อมูลตารางกะสำหรับวันที่นี้</p>';
                return;
            }
            
            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left">วันที่</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">ประเภทกะ</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">รหัสพนักงาน</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">ชื่อ-สกุล</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">ส่วนงาน</th>
                                <th class="border border-gray-300 px-4 py-2 text-center">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            scheduleData.forEach((item, index) => {
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2">
                            <input type="date" value="${item.date || date}" 
                                   class="w-full border-0 bg-transparent" 
                                   data-row="${index}" data-field="date">
                        </td>
                        <td class="border border-gray-300 px-4 py-2">
                            <select class="w-full border-0 bg-transparent" data-row="${index}" data-field="shiftType">
                                <option value="กลางวัน" ${item.shiftType === 'กลางวัน' ? 'selected' : ''}>กลางวัน</option>
                                <option value="กลางคืน" ${item.shiftType === 'กลางคืน' ? 'selected' : ''}>กลางคืน</option>
                                <option value="เต็มวัน" ${item.shiftType === 'เต็มวัน' ? 'selected' : ''}>เต็มวัน</option>
                            </select>
                        </td>
                        <td class="border border-gray-300 px-4 py-2">
                            <input type="text" value="${item.employeeId || ''}" 
                                   class="w-full border-0 bg-transparent" 
                                   data-row="${index}" data-field="employeeId">
                        </td>
                        <td class="border border-gray-300 px-4 py-2">
                            <input type="text" value="${item.employeeName || ''}" 
                                   class="w-full border-0 bg-transparent" 
                                   data-row="${index}" data-field="employeeName">
                        </td>
                        <td class="border border-gray-300 px-4 py-2">
                            <input type="text" value="${item.department || ''}" 
                                   class="w-full border-0 bg-transparent" 
                                   data-row="${index}" data-field="department">
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <button onclick="removeScheduleRow(${index})" 
                                    class="text-red-600 hover:text-red-800">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                    <div class="mt-4">
                        <button onclick="addScheduleRow()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                            <span class="material-symbols-outlined mr-1 text-base">add</span>
                            เพิ่มแถว
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        };
        
        const saveShiftSchedule = async () => {
            const date = document.getElementById('schedule-date-picker').value;
            if (!date) {
                showMessage('กรุณาเลือกวันที่', true);
                return;
            }
            
            const tableRows = document.querySelectorAll('#schedule-table-container tbody tr');
            const scheduleData = [];
            
            tableRows.forEach(row => {
                const rowDate = row.querySelector('[data-field="date"]').value.trim();
                const shiftType = row.querySelector('[data-field="shiftType"]').value;
                const employeeId = row.querySelector('[data-field="employeeId"]').value.trim();
                const employeeName = row.querySelector('[data-field="employeeName"]').value.trim();
                const department = row.querySelector('[data-field="department"]').value.trim();
                
                if (employeeId && employeeName) {
                    scheduleData.push({
                        date: rowDate || date,
                        shiftType: shiftType,
                        employeeId: employeeId,
                        employeeName: employeeName,
                        department: department
                    });
                }
            });
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'saveShiftSchedule',
                        data: scheduleData
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    showMessage('บันทึกตารางกะเรียบร้อยแล้ว');
                } else {
                    showMessage(result.message || 'เกิดข้อผิดพลาดในการบันทึก', true);
                }
            } catch (error) {
                showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล', true);
            }
        };
        
        // Global functions for schedule management
        window.addScheduleRow = () => {
            const tbody = document.querySelector('#schedule-table-container tbody');
            const newRowIndex = tbody.children.length;
            const currentDate = document.getElementById('schedule-date-picker').value;
            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50';
            newRow.innerHTML = `
                <td class="border border-gray-300 px-4 py-2">
                    <input type="date" value="${currentDate}" class="w-full border-0 bg-transparent" 
                           data-row="${newRowIndex}" data-field="date">
                </td>
                <td class="border border-gray-300 px-4 py-2">
                    <select class="w-full border-0 bg-transparent" data-row="${newRowIndex}" data-field="shiftType">
                        <option value="กลางวัน">กลางวัน</option>
                        <option value="กลางคืน">กลางคืน</option>
                        <option value="เต็มวัน">เต็มวัน</option>
                    </select>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                    <input type="text" value="" class="w-full border-0 bg-transparent" 
                           placeholder="รหัสพนักงาน"
                           data-row="${newRowIndex}" data-field="employeeId">
                </td>
                <td class="border border-gray-300 px-4 py-2">
                    <input type="text" value="" class="w-full border-0 bg-transparent" 
                           placeholder="ชื่อ-สกุล"
                           data-row="${newRowIndex}" data-field="employeeName">
                </td>
                <td class="border border-gray-300 px-4 py-2">
                    <input type="text" value="" class="w-full border-0 bg-transparent" 
                           placeholder="ส่วนงาน"
                           data-row="${newRowIndex}" data-field="department">
                </td>
                <td class="border border-gray-300 px-4 py-2 text-center">
                    <button onclick="removeScheduleRow(this)" 
                            class="text-red-600 hover:text-red-800">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
        };
        
        window.removeScheduleRow = (button) => {
            button.closest('tr').remove();
        };
        
        // Event listeners for shift schedule page
        document.addEventListener('DOMContentLoaded', () => {
            const loadScheduleBtn = document.getElementById('load-schedule-btn');
            const saveScheduleBtn = document.getElementById('save-schedule-btn');
            
            if (loadScheduleBtn) {
                loadScheduleBtn.addEventListener('click', () => {
                    const date = document.getElementById('schedule-date-picker').value;
                    loadShiftSchedule(date);
                });
            }
            
            if (saveScheduleBtn) {
                saveScheduleBtn.addEventListener('click', saveShiftSchedule);
            }
            
            if (typeof updateShiftInfo === 'function') {
                updateShiftInfo();
            }
        });

        // --- OT Report Functions ---
        const initializeOtReportPage = async () => {
            // Set default date range (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('ot-start-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('ot-end-date').value = lastDay.toISOString().split('T')[0];
            
            // Load departments and employees for filters
            await loadOtReportFilters();
        };

        const loadOtReportFilters = async () => {
            try {
                // Load employees for department and employee filters
                const response = await fetch(`${GAS_URL}?action=getEmployees`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const employees = result.data;
                    
                    // Populate department filter
                    const deptFilter = document.getElementById('ot-department-filter');
                    const empFilter = document.getElementById('ot-employee-filter');
                    
                    // Get unique departments
                    const departments = [...new Set(employees.map(emp => emp.department).filter(dept => dept))];
                    
                    deptFilter.innerHTML = '<option value="">ทุกแผนก</option>';
                    departments.forEach(dept => {
                        deptFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
                    });
                    
                    // Populate employee filter
                    empFilter.innerHTML = '<option value="">พนักงานทั้งหมด</option>';
                    employees.forEach(emp => {
                        empFilter.innerHTML += `<option value="${emp.employeeId}">${emp.fullName} (${emp.employeeId})</option>`;
                    });
                    
                    // Add department filter change event
                    deptFilter.addEventListener('change', () => {
                        const selectedDept = deptFilter.value;
                        empFilter.innerHTML = '<option value="">พนักงานทั้งหมด</option>';
                        
                        const filteredEmployees = selectedDept ? 
                            employees.filter(emp => emp.department === selectedDept) : 
                            employees;
                            
                        filteredEmployees.forEach(emp => {
                            empFilter.innerHTML += `<option value="${emp.employeeId}">${emp.fullName} (${emp.employeeId})</option>`;
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading OT report filters:', error);
                showMessage('เกิดข้อผิดพลาดในการโหลดตัวกรองข้อมูล', true);
            }
        };

        const loadOtReport = async () => {
            const startDate = document.getElementById('ot-start-date').value;
            const endDate = document.getElementById('ot-end-date').value;
            const department = document.getElementById('ot-department-filter').value;
            const employeeId = document.getElementById('ot-employee-filter').value;
            
            if (!startDate || !endDate) {
                showMessage('กรุณาเลือกช่วงวันที่', true);
                return;
            }
            
            const loadBtn = document.getElementById('load-ot-report-btn');
            const originalText = loadBtn.textContent;
            loadBtn.disabled = true;
            loadBtn.textContent = 'กำลังโหลด...';
            
            try {
                const params = new URLSearchParams({
                    action: 'getOtReport',
                    startDate: startDate,
                    endDate: endDate
                });
                
                if (department) params.append('department', department);
                if (employeeId) params.append('employeeId', employeeId);
                
                const response = await fetch(`${GAS_URL}?${params}`);
                const result = await response.json();
                
                console.log('OT Report API Response:', result);
                console.log('OT Report Data:', result.data);
                
                if (result.status === 'success') {
                    renderOtReport(result.data);
                    showOtSummary(result.data);
                } else {
                    showMessage(result.message, true);
                    renderOtReport([]); // Clear table on error
                    showOtSummary([]);
                }
            } catch (error) {
                console.error('Error loading OT report:', error);
                showMessage('เกิดข้อผิดพลาดในการโหลดรายงาน OT', true);
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = `<span class="material-symbols-outlined mr-2">search</span>ค้นหา`;
            }
        };

        const renderOtReport = (data) => {
            const tableContainer = document.getElementById('ot-table-container');

            if (!data || data.length === 0) {
                tableContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2">search_off</span>
                        <p>ไม่พบข้อมูล OT ในช่วงเวลาที่เลือก</p>
                    </div>`;
                return;
            }
            
            let tableHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสพนักงาน</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แผนก</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ชั่วโมง OT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            data.forEach(record => {
                const startTime = record.startTime || '';
                const endTime = record.endTime || '';
                let otHours = 0;

                console.log('Processing record:', {
                    employeeId: record.employeeId,
                    employeeName: record.employeeName,
                    startTime: startTime,
                    endTime: endTime,
                    otHours: record.otHours,
                    rawRecord: record
                });

                // Use pre-calculated OT hours from sheet if available
                if (record.otHours !== undefined && record.otHours !== null && record.otHours !== '') {
                    otHours = parseFloat(record.otHours) || 0;
                    console.log('Using pre-calculated OT hours:', otHours);
                } else if (startTime && endTime) {
                    // Fallback to calculation if OT hours not available
                    const [startHour, startMin] = startTime.split(':').map(Number);
                    const [endHour, endMin] = endTime.split(':').map(Number);
                    let startMinutes = startHour * 60 + startMin;
                    let endMinutes = endHour * 60 + endMin;

                    console.log('Time calculation (fallback):', {
                        startTime, endTime,
                        startHour, startMin, endHour, endMin,
                        startMinutes, endMinutes
                    });

                    if (endMinutes < startMinutes) { // Handle overnight OT
                        endMinutes += 24 * 60;
                        console.log('Overnight OT detected, adjusted endMinutes:', endMinutes);
                    }
                    const diffMinutes = endMinutes - startMinutes;
                    if (diffMinutes > 0) {
                       otHours = diffMinutes / 60;
                    }
                    
                    console.log('Final calculation:', {
                        diffMinutes, otHours
                    });
                } else {
                    console.log('No OT hours data and missing time data:', { startTime, endTime, otHours: record.otHours });
                }
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${record.employeeId || ''}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${record.employeeName || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${record.department || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold text-center">${otHours.toFixed(1)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${record.notes || ''}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        };

        const showOtSummary = (data) => {
            const summarySection = document.getElementById('ot-summary');
            const totalOtHoursEl = document.getElementById('total-ot-hours');
            const totalOtEmployeesEl = document.getElementById('total-ot-employees');
            const avgOtHoursEl = document.getElementById('avg-ot-hours');
            const totalOtDaysEl = document.getElementById('total-ot-days');

            let totalHours = 0;
            const employeeSet = new Set();
            const otDaysSet = new Set();
            
            if (data && data.length > 0) {
                 data.forEach(record => {
                    let hours = 0;
                    
                    // Use pre-calculated OT hours from sheet if available
                    if (record.otHours !== undefined && record.otHours !== null && record.otHours !== '') {
                        hours = parseFloat(record.otHours) || 0;
                    } else {
                        // Fallback to calculation
                        const startTime = record.startTime || '';
                        const endTime = record.endTime || '';
                        if (startTime && endTime) {
                            const [startHour, startMin] = startTime.split(':').map(Number);
                            const [endHour, endMin] = endTime.split(':').map(Number);
                            let startMinutes = startHour * 60 + startMin;
                            let endMinutes = endHour * 60 + endMin;

                            if (endMinutes < startMinutes) {
                                endMinutes += 24 * 60;
                            }
                            const diffMinutes = endMinutes - startMinutes;
                            if (diffMinutes > 0) {
                               hours = diffMinutes / 60;
                            }
                        }
                    }
                    
                    if (hours > 0) {
                        totalHours += hours;
                        employeeSet.add(record.employeeId);
                        otDaysSet.add(record.date);
                    }
                });
            }

            const employeeCount = employeeSet.size;
            if (employeeCount > 0) {
                totalOtHoursEl.textContent = totalHours.toFixed(1);
                totalOtEmployeesEl.textContent = employeeCount;
                avgOtHoursEl.textContent = (totalHours / employeeCount).toFixed(1);
                totalOtDaysEl.textContent = otDaysSet.size;
                summarySection.classList.remove('hidden');
            } else {
                summarySection.classList.add('hidden');
            }
        };

        const exportOtToExcel = () => {
            const table = document.querySelector('#ot-table-container table');
            if (!table) {
                showMessage('ไม่มีข้อมูลสำหรับส่งออก', true);
                return;
            }
            
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            let csvContent = headers.join(',') + '\n';
            
            Array.from(table.querySelectorAll('tbody tr')).forEach(row => {
                const cells = Array.from(row.children).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cells.join(',') + '\n';
            });
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `OT_Report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('ส่งออกข้อมูลเป็นไฟล์ Excel (CSV) เรียบร้อยแล้ว');
        };

        const printOtReport = () => {
            const table = document.querySelector('#ot-table-container table');
            if (!table) {
                showMessage('ไม่มีข้อมูลสำหรับพิมพ์', true);
                return;
            }
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>รายงาน OT</title>');
            printWindow.document.write('<style>body { font-family: "Noto Sans Thai", sans-serif; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; } th { background-color: #f2f2f2; } </style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h2>รายงาน OT (${document.getElementById('ot-start-date').value} - ${document.getElementById('ot-end-date').value})</h2>`);
            printWindow.document.write(table.outerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        };

        const clearOtFilters = () => {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('ot-start-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('ot-end-date').value = lastDay.toISOString().split('T')[0];
            document.getElementById('ot-department-filter').value = '';
            document.getElementById('ot-employee-id-filter').value = '';
            
            // Clear table and summary
            const tableBody = document.getElementById('ot-report-tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            document.getElementById('ot-summary-section').classList.add('hidden');
            document.getElementById('ot-no-data').classList.add('hidden');
        };

        // Event listeners for OT Report
        document.addEventListener('DOMContentLoaded', () => {
            const loadOtReportBtn = document.getElementById('load-ot-report-btn');
            const exportOtExcelBtn = document.getElementById('export-ot-excel-btn');
            const printOtReportBtn = document.getElementById('print-ot-report-btn');
            
            if (loadOtReportBtn) {
                loadOtReportBtn.addEventListener('click', loadOtReport);
            }
            
            if (exportOtExcelBtn) {
                exportOtExcelBtn.addEventListener('click', exportOtToExcel);
            }
            
            if (printOtReportBtn) {
                printOtReportBtn.addEventListener('click', printOtReport);
            }

            // Tab switching functionality for shift management
            const shiftAssignmentTab = document.getElementById('shift-assignment-tab');
            const shiftSummaryTab = document.getElementById('shift-summary-tab');
            const shiftAssignmentContent = document.getElementById('shift-assignment-content');
            const shiftSummaryContent = document.getElementById('shift-summary-content-tab');

            if (shiftAssignmentTab && shiftSummaryTab) {
                shiftAssignmentTab.addEventListener('click', () => {
                    // Switch to assignment tab
                    shiftAssignmentTab.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
                    shiftAssignmentTab.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700');
                    shiftSummaryTab.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
                    shiftSummaryTab.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700');
                    
                    shiftAssignmentContent.classList.remove('hidden');
                    shiftSummaryContent.classList.add('hidden');
                });

                shiftSummaryTab.addEventListener('click', () => {
                    // Switch to summary tab
                    shiftSummaryTab.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
                    shiftSummaryTab.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700');
                    shiftAssignmentTab.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
                    shiftAssignmentTab.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700');
                    
                    shiftSummaryContent.classList.remove('hidden');
                    shiftAssignmentContent.classList.add('hidden');
                });
            }
        });
        

    </script>

</body>
</html>


