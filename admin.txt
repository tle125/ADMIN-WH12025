<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนและเข้าสู่ระบบ</title>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #135bec;
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .page-container {
             font-family: "Noto Sans Thai", "Inter", sans-serif;
             width: 100%;
             max-width: 100%;
        }
        #message-box {
            transition: opacity 0.3s ease-in-out;
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: calc(100% - 2rem);
            max-width: 400px;
        }
        /* Style for select dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24' 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 flex justify-center items-center min-h-screen">
    
    <div id="message-box" class="p-4 mb-4 text-sm rounded-lg opacity-0" role="alert"></div>

    <!-- Auth Wrapper -->
    <div id="auth-wrapper" class="w-full max-w-sm p-8">
        <!-- Registration Form -->
        <div id="register-container" class="hidden">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800 tracking-tighter">Create Account</h1>
                <p class="text-gray-500 mt-2">Let's get you started!</p>
            </div>
            <form id="register-form" class="space-y-6">
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">person</span><input id="register-username" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Username" type="text" required></div>
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">badge</span><input id="register-fullname" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="ชื่อ-นามสกุล" type="text" required></div>
                
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">work</span>
                    <select id="register-position" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" required>
                        <option value="" disabled selected>กรุณาเลือกตำแหน่ง</option>
                        <option value="Senior Warehouse Manager">Senior Warehouse Manager</option>
                        <option value="Asistant Warehouse Manager">Asistant Warehouse Manager</option>
                        <option value="Warehouse Supervisor">Warehouse Supervisor</option>
                        <option value="Sr.Warehouse Officer">Sr.Warehouse Officer</option>
                        <option value="Warehouse Officer">Warehouse Officer</option>
                        <option value="Sr.Forklift Driver">Sr.Forklift Driver</option>
                        <option value="Technical Service Forklift">Technical Service Forklift</option>
                        <option value="Forklift Driver">Forklift Driver</option>
                        <option value="Sr.Inspector">Sr.Inspector</option>
                        <option value="Inspector">Inspector</option>
                        <option value="Operator">Operator</option>
                    </select>
                </div>

                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">groups</span>
                    <select id="register-department" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" required>
                        <option value="" disabled selected>กรุณาเลือกส่วนงาน</option>
                        <option value="Warehouse Manager">Warehouse Manager</option>
                        <option value="Asistant Warehouse Manager">Asistant Warehouse Manager</option>
                        <option value="A&I">A&I</option>
                        <option value="MH">MH</option>
                        <option value="SSRM">SSRM</option>
                        <option value="COIL">COIL</option>
                        <option value="FILM">FILM</option>
                    </select>
                </div>
                
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock</span><input id="register-password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Password" type="password" required></div>
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock_reset</span><input id="confirm-password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Confirm Password" type="password" required></div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">Register</button>
            </form>
            <div class="text-center mt-6"><p class="text-sm text-gray-500">Already have an account? <a href="#" id="show-login" class="font-semibold text-[var(--primary-color)] hover:underline">Login</a></p></div>
        </div>

        <!-- Login Form -->
        <div id="login-container">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800 tracking-tighter">Welcome Back!</h1>
                <p class="text-gray-500 mt-2">Please login to your account.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">person</span><input id="login-username" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Username / Employee ID" type="text" required></div>
                <div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock</span><input id="login-password" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-shadow duration-200" placeholder="Password" type="password" required></div>
                <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">Login</button>
            </form>
            <div class="text-center mt-6"><p class="text-sm text-gray-500">Don't have an account? <a href="#" id="show-register" class="font-semibold text-[var(--primary-color)] hover:underline">Register</a></p></div>
        </div>
    </div>
    
    <!-- Home Page -->
    <div id="home-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 bg-white shadow-sm w-full flex-shrink-0"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">หน้าหลัก</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main class="flex-1 p-6 flex justify-center items-center"><h2 class="text-2xl text-gray-600">ยินดีต้อนรับสู่หน้าหลัก</h2></main>
        <footer class="bg-white shadow-t w-full flex-shrink-0"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="ot-plan" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">schedule</span><p class="text-xs font-medium">Plan OT</p></a><a href="#" data-page="settings" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">settings</span><p class="text-xs font-medium">ตั้งค่า</p></a></nav></footer>
    </div>
    
    <!-- Employee List Page -->
    <div id="employee-list-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 bg-white shadow-sm w-full flex-shrink-0"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">รายชื่อพนักงาน</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main id="employee-list-main" class="flex-1 p-4 md:p-6 overflow-y-auto"></main>
         <button id="add-employee-fab" class="fixed bottom-20 right-6 bg-[var(--primary-600)] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-[var(--primary-700)] transition-transform transform hover:scale-110"><span class="material-symbols-outlined">add</span></button>
        <footer class="bg-white shadow-t w-full flex-shrink-0"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="ot-plan" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">schedule</span><p class="text-xs font-medium">Plan OT</p></a><a href="#" data-page="settings" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">settings</span><p class="text-xs font-medium">ตั้งค่า</p></a></nav></footer>
    </div>

    <!-- Add/Edit Employee Page -->
    <div id="add-employee-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-start p-4 bg-white shadow-sm w-full flex-shrink-0"><button id="back-to-list-button" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-100"><span class="material-symbols-outlined text-gray-700">arrow_back_ios_new</span></button><h1 id="employee-form-title" class="text-xl font-bold text-gray-800 flex-1 text-center">เพิ่มข้อมูลพนักงาน</h1><div class="w-10"></div></header>
        <main class="flex-1 p-6 space-y-6 overflow-y-auto">
            <div class="flex flex-col items-center space-y-4">
                <div class="relative w-32 h-32"><img alt="Employee Photo" id="photo-preview" class="w-full h-full rounded-full object-cover" src="https://placehold.co/128x128/EFEFEF/AAAAAA?text=Photo"><label class="absolute bottom-0 right-0 flex items-center justify-center w-10 h-10 bg-[var(--primary-600)] rounded-full cursor-pointer hover:bg-[var(--primary-700)]" for="photo-upload"><span class="material-symbols-outlined text-white">photo_camera</span><input class="hidden" id="photo-upload" type="file" accept="image/*"></label></div>
                <p class="text-gray-500 text-sm">อัปโหลดรูปถ่ายพนักงาน</p>
            </div>
            <form id="employee-form" class="space-y-6">
                <div><label class="block text-sm font-medium text-gray-700" for="full-name">ชื่อ-นามสกุล</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="full-name" placeholder="เช่น สุดา สุนทร" type="text"></div>
                <div><label class="block text-sm font-medium text-gray-700" for="employee-id">รหัสพนักงาน</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="employee-id" placeholder="เช่น 123456" type="text"></div>
                <div><label class="block text-sm font-medium text-gray-700" for="department">ส่วนงาน</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="department" placeholder="เช่น ฝ่ายขาย" type="text"></div>
                <div><label class="block text-sm font-medium text-gray-700" for="position">ตำแหน่ง</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm" id="position" placeholder="เช่น พนักงานขาย" type="text"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="role">Role (สิทธิ์การเข้าถึง)</label>
                    <select id="role" class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium text-gray-700" for="start-date">วันที่เริ่มงาน</label><input class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm text-gray-500" id="start-date" type="date"></div>
            </form>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0"><div class="px-6 py-4"><button id="save-employee-button" type="submit" form="employee-form" class="w-full flex items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-[var(--primary-600)] text-white text-base font-bold leading-normal tracking-wide shadow-md hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]"><span class="truncate">บันทึก</span></button></div></footer>
    </div>

    <!-- OT Plan Page -->
    <div id="ot-plan-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 bg-white shadow-sm w-full flex-shrink-0"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">วางแผน OT</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main id="ot-plan-main" class="flex-1 p-4 md:p-6 overflow-y-auto">
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4 sticky top-0 z-10">
                <div class="flex items-center justify-between mb-4">
                     <h2 class="text-lg font-semibold text-gray-800">เลือกวันที่</h2>
                    <input type="date" id="ot-date-picker" class="border border-gray-300 rounded-lg p-2">
                </div>
                 <button id="save-ot-plan-btn" class="w-full bg-[var(--primary-600)] text-white px-4 py-3 rounded-lg hover:bg-[var(--primary-700)] transition-colors font-bold">
                    บันทึกแผน OT
                </button>
            </div>
            <div id="ot-employee-list" class="space-y-4"></div>
        </main>
        <footer class="bg-white shadow-t w-full flex-shrink-0"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="ot-plan" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">schedule</span><p class="text-xs font-medium">Plan OT</p></a><a href="#" data-page="settings" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">settings</span><p class="text-xs font-medium">ตั้งค่า</p></a></nav></footer>
    </div>
    
    <!-- Settings Page -->
    <div id="settings-container" class="page-container hidden flex flex-col h-screen w-full bg-gray-50">
        <header class="flex items-center justify-between p-4 bg-white shadow-sm w-full flex-shrink-0"><div class="w-10"></div><h1 class="text-xl font-bold text-gray-800">ตั้งค่า</h1><button class="logout-button flex items-center justify-center p-2 rounded-full hover:bg-gray-100" title="Logout"><span class="material-symbols-outlined text-gray-700">logout</span></button></header>
        <main class="flex-1 p-6 flex justify-center items-center"><h2 class="text-2xl text-gray-600">ยินดีต้อนรับสู่หน้าตั้งค่า</h2></main>
        <footer class="bg-white shadow-t w-full flex-shrink-0"><nav class="flex justify-around border-t border-gray-200 py-2"><a href="#" data-page="home" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">home</span><p class="text-xs font-medium">หน้าหลัก</p></a><a href="#" data-page="employee-list" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">groups</span><p class="text-xs font-medium">พนักงาน</p></a><a href="#" data-page="ot-plan" class="nav-link flex flex-col items-center justify-end gap-1 text-gray-500 hover:text-[var(--primary-600)]"><span class="material-symbols-outlined">schedule</span><p class="text-xs font-medium">Plan OT</p></a><a href="#" data-page="settings" class="nav-link flex flex-col items-center justify-end gap-1 text-[var(--primary-600)] font-semibold"><span class="material-symbols-outlined">settings</span><p class="text-xs font-medium">ตั้งค่า</p></a></nav></footer>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <span class="material-symbols-outlined text-red-600">warning</span>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">ลบข้อมูลพนักงาน</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลพนักงานคนนี้? การกระทำนี้ไม่สามารถย้อนกลับได้
                    </p>
                    <p id="employee-to-delete-name" class="font-bold text-gray-800 mt-2"></p>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex">
                    <button id="cancel-delete-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                        ยกเลิก
                    </button>
                    <button id="confirm-delete-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700">
                        ยืนยันการลบ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbwCjCZSLwe4n688I24ecEIDauCjlVNsrCqcPHyOf7Bv3wT5unbPwjgWgoADzuMcWP7Axg/exec';

            // State variables
            let isEditMode = false;
            let editingEmployeeId = null;
            let photoBase64 = null;
            let messageTimeout = null;
            let employeeIdToDelete = null;
            
            // Wrappers & Containers
            const containers = {
                auth: document.getElementById('auth-wrapper'),
                register: document.getElementById('register-container'),
                login: document.getElementById('login-container'),
                home: document.getElementById('home-container'),
                employeeList: document.getElementById('employee-list-container'),
                addEmployee: document.getElementById('add-employee-container'),
                otPlan: document.getElementById('ot-plan-container'),
                settings: document.getElementById('settings-container'),
            };
            
            // Forms, Inputs, etc.
            const registerForm = document.getElementById('register-form');
            const loginForm = document.getElementById('login-form');
            const employeeForm = document.getElementById('employee-form');
            const photoUploadInput = document.getElementById('photo-upload');
            const photoPreview = document.getElementById('photo-preview');
            const employeeListMain = document.getElementById('employee-list-main');
            const messageBox = document.getElementById('message-box');
            const employeeFormTitle = document.getElementById('employee-form-title');
            const saveEmployeeButtonSpan = document.getElementById('save-employee-button').querySelector('span');
            const deleteModal = document.getElementById('delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const employeeToDeleteName = document.getElementById('employee-to-delete-name');
            const otDatePicker = document.getElementById('ot-date-picker');
            const otEmployeeList = document.getElementById('ot-employee-list');
            const saveOtPlanBtn = document.getElementById('save-ot-plan-btn');


            // --- FUNCTIONS ---
            const showMessage = (message, isError = false) => {
                if (messageTimeout) clearTimeout(messageTimeout);

                messageBox.textContent = message;
                messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
                
                if (isError) {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                }
                
                messageBox.classList.remove('opacity-0');

                messageTimeout = setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                }, 3000);
            };

            const resetEmployeeForm = () => {
                isEditMode = false;
                editingEmployeeId = null;
                employeeFormTitle.textContent = 'เพิ่มข้อมูลพนักงาน';
                employeeForm.reset();
                document.getElementById('employee-id').readOnly = false;
                photoPreview.src = 'https://placehold.co/128x128/EFEFEF/AAAAAA?text=Photo';
                photoBase64 = null;
                photoUploadInput.value = '';
                saveEmployeeButtonSpan.textContent = 'บันทึก';
            };

            const openEditEmployeeForm = (emp) => {
                isEditMode = true;
                editingEmployeeId = emp.employeeId;
                employeeFormTitle.textContent = 'แก้ไขข้อมูลพนักงาน';

                document.getElementById('full-name').value = emp.fullName || '';
                document.getElementById('employee-id').value = emp.employeeId || '';
                document.getElementById('employee-id').readOnly = true;
                document.getElementById('department').value = emp.department || '';
                document.getElementById('position').value = emp.position || '';
                document.getElementById('role').value = emp.role || 'User';
                
                try {
                    document.getElementById('start-date').value = emp.startDate ? new Date(emp.startDate).toISOString().split('T')[0] : '';
                } catch(e){
                    document.getElementById('start-date').value = '';
                }

                photoPreview.src = emp.photoUrl || 'https://placehold.co/128x128/EFEFEF/AAAAAA?text=Photo';
                photoBase64 = null; 

                saveEmployeeButtonSpan.textContent = 'อัปเดต';
                toggleView('add-employee');
            };

            const openDeleteConfirmation = (emp) => {
                employeeIdToDelete = emp.employeeId;
                employeeToDeleteName.textContent = `${emp.fullName} (ID: ${emp.employeeId})`;
                deleteModal.classList.remove('hidden');
                deleteModal.classList.add('flex');
            };

            const closeDeleteConfirmation = () => {
                employeeIdToDelete = null;
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
            };
            
            const handleDelete = async () => {
                if (!employeeIdToDelete) return;

                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = 'กำลังลบ...';

                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'deleteEmployee',
                            employeeId: employeeIdToDelete
                        })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('ลบข้อมูลพนักงานเรียบร้อยแล้ว');
                        fetchAndDisplayEmployees();
                    } else {
                        showMessage(result.message, true);
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการลบข้อมูล', true);
                } finally {
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'ยืนยันการลบ';
                    closeDeleteConfirmation();
                }
            };

            const renderEmployeeList = (employees) => {
                employeeListMain.innerHTML = '';
                if (!employees || employees.length === 0) {
                    employeeListMain.innerHTML = `<p class="text-center text-gray-500 mt-8">ยังไม่มีข้อมูลพนักงาน</p>`;
                    return;
                }

                const groupedByDept = employees.reduce((acc, emp) => {
                    const dept = emp.department || 'ไม่ระบุส่วนงาน';
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(emp);
                    return acc;
                }, {});

                for (const dept in groupedByDept) {
                    const deptContainer = document.createElement('div');
                    deptContainer.className = 'mb-6';
                    
                    const deptHeader = document.createElement('h2');
                    deptHeader.className = 'text-lg font-bold text-gray-700 mb-3 px-2';
                    deptHeader.textContent = dept;
                    deptContainer.appendChild(deptHeader);

                    const grid = document.createElement('div');
                    grid.className = 'space-y-3';
                    
                    groupedByDept[dept].forEach(emp => {
                        const card = document.createElement('div');
                        card.className = 'flex items-center bg-white p-3 rounded-xl shadow-sm space-x-4';
                        const photoSrc = emp.photoUrl || 'https://placehold.co/64x64/EFEFEF/AAAAAA?text=No+Img';
                        
                        // คำนวณอายุงาน
                        const calculateWorkExperience = (startDate) => {
                            if (!startDate) return 'ไม่ระบุ';
                            const start = new Date(startDate);
                            const now = new Date();
                            if (isNaN(start.getTime())) return 'ไม่ระบุ';
                            const diffTime = Math.abs(now - start);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            const years = Math.floor(diffDays / 365);
                            const months = Math.floor((diffDays % 365) / 30);
                            
                            let result = '';
                            if(years > 0) result += `${years} ปี `;
                            if(months > 0) result += `${months} เดือน`;
                            
                            return result.trim() || 'น้อยกว่า 1 เดือน';
                        };
                        
                        const workExperience = calculateWorkExperience(emp.startDate);
                        
                        card.innerHTML = `
                            <img src="${photoSrc}" alt="${emp.fullName}" class="w-16 h-16 rounded-full object-cover bg-gray-200" onerror="this.src='https://placehold.co/64x64/EFEFEF/AAAAAA?text=Error'">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">${emp.fullName}</p>
                                <p class="text-sm text-gray-500">${emp.position || '-'}</p>
                                <p class="text-xs text-gray-400 mt-1">ID: ${emp.employeeId} | Role: ${emp.role || 'User'}</p>
                                <p class="text-xs text-blue-600 mt-1">อายุงาน: ${workExperience}</p>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button class="edit-employee-btn p-2 rounded-full hover:bg-gray-100 transition-colors">
                                    <span class="material-symbols-outlined text-gray-600">edit</span>
                                </button>
                                <button class="delete-employee-btn p-2 rounded-full hover:bg-red-100 transition-colors">
                                    <span class="material-symbols-outlined text-red-500">delete</span>
                                </button>
                            </div>
                        `;
                        card.querySelector('.edit-employee-btn').addEventListener('click', () => openEditEmployeeForm(emp));
                        card.querySelector('.delete-employee-btn').addEventListener('click', () => openDeleteConfirmation(emp));
                        grid.appendChild(card);
                    });

                    deptContainer.appendChild(grid);
                    employeeListMain.appendChild(deptContainer);
                }
            };

            const fetchAndDisplayEmployees = async () => {
                employeeListMain.innerHTML = `<p class="text-center text-gray-500 mt-8">กำลังโหลดข้อมูล...</p>`;
                try {
                    const response = await fetch(`${GAS_URL}?action=getEmployees`);
                    const result = await response.json();
                    if (result.status === 'success') {
                        renderEmployeeList(result.data);
                    } else {
                        showMessage(result.message, true);
                        employeeListMain.innerHTML = `<p class="text-center text-red-500 mt-8">ไม่สามารถโหลดข้อมูลได้</p>`;
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', true);
                    employeeListMain.innerHTML = `<p class="text-center text-red-500 mt-8">เกิดข้อผิดพลาดในการเชื่อมต่อ</p>`;
                }
            };
            
            // --- OT Plan Functions ---
            const initializeOtPlanPage = () => {
                const today = new Date().toISOString().split('T')[0];
                otDatePicker.value = today;
                fetchEmployeesForOtPlan(today);
            };

            const fetchEmployeesForOtPlan = async (date) => {
                 otEmployeeList.innerHTML = `<p class="text-center text-gray-500 mt-8">กำลังโหลดข้อมูล...</p>`;
                try {
                    const empResponse = await fetch(`${GAS_URL}?action=getEmployees`);
                    const empResult = await empResponse.json();

                    const planResponse = await fetch(`${GAS_URL}?action=getOtPlan&date=${date}`);
                    const planResult = await planResponse.json();

                    if (empResult.status === 'success') {
                        const existingPlan = planResult.status === 'success' ? planResult.data : [];
                        renderOtPlanList(empResult.data, existingPlan);
                    } else {
                        showMessage(empResult.message, true);
                        otEmployeeList.innerHTML = `<p class="text-center text-red-500 mt-8">ไม่สามารถโหลดข้อมูลพนักงานได้</p>`;
                    }
                } catch (error) {
                    showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', true);
                    otEmployeeList.innerHTML = `<p class="text-center text-red-500 mt-8">เกิดข้อผิดพลาดในการเชื่อมต่อ</p>`;
                }
            };

            const renderOtPlanList = (employees, existingPlan) => {
                otEmployeeList.innerHTML = '';
                 if (!employees || employees.length === 0) {
                    otEmployeeList.innerHTML = `<p class="text-center text-gray-500 mt-8">ยังไม่มีข้อมูลพนักงาน</p>`;
                    return;
                }

                const planMap = existingPlan.reduce((acc, plan) => {
                    acc[plan.employeeId] = plan;
                    return acc;
                }, {});

                const groupedByDept = employees.reduce((acc, emp) => {
                    const dept = emp.department || 'ไม่ระบุส่วนงาน';
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(emp);
                    return acc;
                }, {});

                for (const dept in groupedByDept) {
                    const deptContainer = document.createElement('div');
                    deptContainer.className = 'bg-white rounded-lg shadow-sm';
                    
                    const deptHeader = document.createElement('h3');
                    deptHeader.className = 'text-md font-bold text-gray-800 p-4 border-b';
                    deptHeader.textContent = dept;
                    deptContainer.appendChild(deptHeader);
                    
                    const list = document.createElement('div');
                    list.className = 'divide-y';

                    groupedByDept[dept].forEach(emp => {
                        const plan = planMap[emp.employeeId] || {};
                        const card = document.createElement('div');
                        card.className = 'p-4';
                        card.dataset.employeeId = emp.employeeId;

                        const isOt = !!plan.startTime;

                        card.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <input type="checkbox" class="ot-checkbox mt-1 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${isOt ? 'checked' : ''}>
                                <img src="${emp.photoUrl || 'https://placehold.co/48x48/EFEFEF/AAAAAA?text=No+Img'}" alt="${emp.fullName}" class="w-12 h-12 rounded-full object-cover bg-gray-200">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">${emp.fullName}</p>
                                    <p class="text-sm text-gray-500">${emp.employeeId}</p>
                                </div>
                            </div>
                            <div class="ot-details pl-16 mt-2 space-y-2 ${isOt ? '' : 'hidden'}">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500">เวลาเริ่ม</label>
                                        <input type="time" class="ot-start-time w-full border border-gray-300 rounded p-1 text-sm" value="${plan.startTime || ''}">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">เวลาสิ้นสุด</label>
                                        <input type="time" class="ot-end-time w-full border border-gray-300 rounded p-1 text-sm" value="${plan.endTime || ''}">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">หมายเหตุ / งาน</label>
                                    <input type="text" class="ot-notes w-full border border-gray-300 rounded p-1 text-sm" placeholder="ระบุงานที่ทำ" value="${plan.notes || ''}">
                                </div>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                     deptContainer.appendChild(list);
                     otEmployeeList.appendChild(deptContainer);
                }

                // Add event listeners
                otEmployeeList.querySelectorAll('.ot-checkbox').forEach(box => {
                    box.addEventListener('change', (e) => {
                        const card = e.target.closest('[data-employee-id]');
                        const details = card.querySelector('.ot-details');
                        if (e.target.checked) {
                            details.classList.remove('hidden');
                        } else {
                            details.classList.add('hidden');
                        }
                    });
                });
            };

            const handleSaveOtPlan = async () => {
                const date = otDatePicker.value;
                if (!date) {
                    showMessage('กรุณาเลือกวันที่', true);
                    return;
                }

                const plans = [];
                otEmployeeList.querySelectorAll('[data-employee-id]').forEach(card => {
                    const checkbox = card.querySelector('.ot-checkbox');
                    if(checkbox.checked) {
                        const employeeId = card.dataset.employeeId;
                        const startTime = card.querySelector('.ot-start-time').value;
                        const endTime = card.querySelector('.ot-end-time').value;
                        const notes = card.querySelector('.ot-notes').value;
                        
                        if(startTime && endTime) {
                            plans.push({ employeeId, startTime, endTime, notes });
                        }
                    }
                });

                saveOtPlanBtn.disabled = true;
                saveOtPlanBtn.textContent = 'กำลังบันทึก...';
                
                try {
                     const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'saveOtPlan',
                            data: { date, plans }
                        })
                    });
                    const result = await response.json();
                    if(result.status === 'success') {
                        showMessage('บันทึกแผน OT เรียบร้อยแล้ว');
                    } else {
                        showMessage(result.message, true);
                    }

                } catch(error) {
                    showMessage('เกิดข้อผิดพลาดในการบันทึก', true);
                } finally {
                    saveOtPlanBtn.disabled = false;
                    saveOtPlanBtn.textContent = 'บันทึกแผน OT';
                }
            };

            otDatePicker.addEventListener('change', () => {
                fetchEmployeesForOtPlan(otDatePicker.value);
            });
            saveOtPlanBtn.addEventListener('click', handleSaveOtPlan);


            const toggleView = (show) => {
                Object.values(containers).forEach(c => c.classList.add('hidden'));
                const pageMap = {
                    'login': ['auth', 'login'], 'register': ['auth', 'register'],
                    'home': ['home'], 'employee-list': ['employeeList'],
                    'add-employee': ['addEmployee'], 'settings': ['settings'],
                    'ot-plan': ['otPlan']
                };
                if (pageMap[show]) {
                    pageMap[show].forEach(key => containers[key].classList.remove('hidden'));
                }
                // Highlight active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.page === show) {
                        link.classList.remove('text-gray-500', 'hover:text-[var(--primary-600)]');
                        link.classList.add('text-[var(--primary-600)]', 'font-semibold');
                    } else {
                         link.classList.add('text-gray-500', 'hover:text-[var(--primary-600)]');
                        link.classList.remove('text-[var(--primary-600)]', 'font-semibold');
                    }
                });
                
                if (show === 'employee-list') { fetchAndDisplayEmployees(); }
                if (show === 'ot-plan') { initializeOtPlanPage(); }
            };
            
            // --- EVENT LISTENERS ---
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleView('login'); });
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); toggleView('register'); });
            document.getElementById('add-employee-fab').addEventListener('click', () => { resetEmployeeForm(); toggleView('add-employee'); });
            document.getElementById('back-to-list-button').addEventListener('click', () => { resetEmployeeForm(); toggleView('employee-list'); });
            document.querySelectorAll('.nav-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); toggleView(link.dataset.page); }); });
            document.querySelectorAll('.logout-button').forEach(button => { button.addEventListener('click', () => { toggleView('login'); showMessage('You have been logged out.'); }); });
            
            cancelDeleteBtn.addEventListener('click', closeDeleteConfirmation);
            confirmDeleteBtn.addEventListener('click', handleDelete);

            photoUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64String = event.target.result;
                        photoPreview.src = base64String;
                        photoBase64 = base64String.split(',')[1];
                    }
                    reader.readAsDataURL(file);
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button');
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                if (password !== confirmPassword) { showMessage('รหัสผ่านไม่ตรงกัน', true); return; }
                button.disabled = true; button.textContent = 'Registering...';
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'register',
                            username: document.getElementById('register-username').value.trim(),
                            password: password,
                            fullName: document.getElementById('register-fullname').value.trim(),
                            position: document.getElementById('register-position').value.trim(),
                            department: document.getElementById('register-department').value.trim()
                        })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('Registration successful! Please login.');
                        registerForm.reset();
                        toggleView('login');
                    } else { showMessage(result.message, true); }
                } catch (error) { showMessage('An error occurred during registration.', true); } 
                finally { button.disabled = false; button.textContent = 'Register'; }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button');
                button.disabled = true; button.textContent = 'Logging in...';
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'login', username: document.getElementById('login-username').value.trim(), password: document.getElementById('login-password').value })
                    });
                    const result = await response.json();
                    if (result.status === 'success' && result.userData) {
                        document.getElementById('full-name').value = result.userData.fullName || '';
                        document.getElementById('position').value = result.userData.position || '';
                        document.getElementById('department').value = result.userData.department || '';
                        toggleView('add-employee');
                        loginForm.reset();
                    } else { showMessage(result.message, true); }
                } catch (error) { showMessage('An error occurred during login.', true); } 
                finally { button.disabled = false; button.textContent = 'Login'; }
            });

            employeeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('save-employee-button');
                const employeeData = {
                    fullName: document.getElementById('full-name').value.trim(),
                    employeeId: document.getElementById('employee-id').value.trim(),
                    department: document.getElementById('department').value.trim(),
                    position: document.getElementById('position').value.trim(),
                    role: document.getElementById('role').value,
                    startDate: document.getElementById('start-date').value,
                    photo: photoBase64,
                    photoMimeType: photoUploadInput.files[0] ? photoUploadInput.files[0].type : null
                };

                if (!employeeData.fullName || !employeeData.employeeId) { showMessage('กรุณากรอกชื่อ-นามสกุล และรหัสพนักงาน', true); return; }
                
                const action = isEditMode ? 'updateEmployee' : 'addEmployee';
                if(isEditMode){
                    employeeData.originalEmployeeId = editingEmployeeId;
                }

                button.disabled = true; saveEmployeeButtonSpan.textContent = 'กำลังบันทึก...';
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: action, data: employeeData })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage(isEditMode ? 'อัปเดตข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลพนักงานเรียบร้อยแล้ว');
                        resetEmployeeForm();
                        toggleView('employee-list');
                    } else { showMessage(result.message, true); }
                } catch (error) { showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล', true); } 
                finally { button.disabled = false; saveEmployeeButtonSpan.textContent = isEditMode ? 'อัปเดต' : 'บันทึก'; }
            });

            toggleView('login');
        });
    </script>
</body>
</html>

